<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ask Foreman - Construction Estimating Assistant</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --construction-orange: #ff6b35;
        --safety-yellow: #ffc107;
        --concrete-gray: #424242;
        --steel-gray: #616161;
        --blueprint-blue: #1565c0;
        --hi-vis-green: #76ff03;
        --warning-red: #d32f2f;
        --white: #ffffff;
        --light-gray: #f5f5f5;
        --medium-gray: #e0e0e0;
        --dark-gray: #212121;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #37474f 0%, #263238 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 35px,
            rgba(255, 193, 7, 0.03) 35px,
            rgba(255, 193, 7, 0.03) 70px
          ),
          repeating-linear-gradient(
            -45deg,
            transparent,
            transparent 35px,
            rgba(255, 107, 53, 0.03) 35px,
            rgba(255, 107, 53, 0.03) 70px
          );
        pointer-events: none;
      }

      .header {
        background: linear-gradient(
          135deg,
          var(--dark-gray) 0%,
          var(--concrete-gray) 100%
        );
        color: white;
        padding: 1rem 2rem;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 4px solid var(--safety-yellow);
        position: relative;
        z-index: 10;
      }

      .header::before {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 0;
        right: 0;
        height: 4px;
        background: repeating-linear-gradient(
          90deg,
          var(--safety-yellow) 0px,
          var(--safety-yellow) 20px,
          var(--dark-gray) 20px,
          var(--dark-gray) 40px
        );
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .logo-icon {
        width: 120px;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        overflow: hidden;
      }

      .logo-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .logo h1 {
        font-size: 2.2rem;
        font-weight: bold;
        color: var(--safety-yellow);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        letter-spacing: 1px;
      }

      .logo .tagline {
        font-size: 1rem;
        color: var(--medium-gray);
        font-weight: 500;
        margin-top: -0.25rem;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(118, 255, 3, 0.1);
        border: 2px solid var(--hi-vis-green);
        border-radius: 20px;
      }
      
      .maintenance-btn {
        margin-left: 1rem;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, var(--warning-red), #b71c1c);
        color: white;
        border: 2px solid var(--warning-red);
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .maintenance-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(211, 47, 47, 0.3);
      }

      .status-dot {
        width: 10px;
        height: 10px;
        background: var(--hi-vis-green);
        border-radius: 50%;
        animation: pulse 2s infinite;
        box-shadow: 0 0 10px var(--hi-vis-green);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.2);
        }
      }

      .container {
        flex: 1;
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 2rem;
        padding: 2rem;
        max-width: 1600px;
        margin: 0 auto;
        width: 100%;
        position: relative;
        z-index: 1;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .card {
        background: var(--white);
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: var(--shadow-lg);
        border: 2px solid var(--medium-gray);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--construction-orange);
      }

      .client-selector {
        margin-bottom: 1rem;
        padding: 1rem;
        background: linear-gradient(
          135deg,
          var(--light-gray) 0%,
          var(--white) 100%
        );
        border-radius: 8px;
        border: 2px solid var(--construction-orange);
      }

      .client-selector label {
        display: block;
        font-weight: 600;
        color: var(--concrete-gray);
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .client-selector select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--medium-gray);
        border-radius: 5px;
        font-size: 1rem;
        background: white;
        color: var(--concrete-gray);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .client-selector select:hover {
        border-color: var(--construction-orange);
      }

      .client-selector select:focus {
        outline: none;
        border-color: var(--construction-orange);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
      }

      .document-categories {
        margin-top: 1rem;
      }

      .document-categories h3 {
        color: var(--concrete-gray);
        margin-bottom: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .document-categories h3::before {
        content: "üìÅ";
        font-size: 1.5rem;
      }

      .category-group {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .category-item {
        background: linear-gradient(
          135deg,
          var(--light-gray) 0%,
          var(--white) 100%
        );
        border: 2px solid var(--medium-gray);
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s ease;
      }

      .category-item:hover {
        border-color: var(--construction-orange);
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
      }

      .category-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .category-header input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--safety-yellow);
      }

      .category-header label {
        flex: 1;
        font-weight: 600;
        color: var(--concrete-gray);
        cursor: pointer;
        font-size: 1rem;
      }

      .category-files {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        padding-left: 2rem;
      }

      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
      }

      .file-input-wrapper input[type="file"] {
        display: none;
      }

      .choose-files-btn {
        background: linear-gradient(
          135deg,
          var(--safety-yellow) 0%,
          #f57f17 100%
        );
        color: var(--dark-gray);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .choose-files-btn:hover {
        background: linear-gradient(
          135deg,
          #f57f17 0%,
          var(--safety-yellow) 100%
        );
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.4);
      }

      .file-count {
        font-size: 0.85rem;
        color: var(--steel-gray);
        font-weight: 500;
      }

      .file-list {
        margin-top: 1.5rem;
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid var(--medium-gray);
        background: white;
        border-radius: 4px;
      }

      .file-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: linear-gradient(135deg, var(--blueprint-blue), #0d47a1);
        color: white;
        border-radius: 8px;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .file-list-header h4 {
        margin: 0;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .file-list-header h4::before {
        content: "üìÇ";
        font-size: 1.2rem;
      }

      .refresh-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.85rem;
      }

      .refresh-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      .existing-file-item {
        display: flex;
        flex-direction: column;
        padding: 0.75rem 1rem;
        background: white;
        border: 1px solid transparent;
        margin: 0 0.5rem 4px 0.5rem;
        transition: all 0.1s ease;
        cursor: pointer;
        user-select: none;
        min-height: 60px;
      }

      .existing-file-item:hover {
        background: #e8f4fd;
        border: 1px solid #0078d4;
      }
      
      .existing-file-item.selected {
        background: #cce8ff;
        border: 1px solid #0078d4;
      }
      
      .folder-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        background: white;
        border: 1px solid transparent;
        margin: 0 0.5rem 2px 0.5rem;
        cursor: pointer;
        user-select: none;
        transition: all 0.1s ease;
        min-height: 40px;
      }
      
      .folder-item:hover {
        background: #e8f4fd;
        border: 1px solid #0078d4;
      }
      
      .folder-item.selected {
        background: #cce8ff;
        border: 1px solid #0078d4;
      }
      
      .file-browser-navigation {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background: #f8f8f8;
        border-bottom: 1px solid var(--medium-gray);
        margin-bottom: 0.75rem;
        gap: 0.75rem;
      }
      
      .nav-button {
        padding: 0.5rem;
        border: 1px solid #ccc;
        background: white;
        cursor: pointer;
        border-radius: 3px;
        font-size: 1.2rem;
        line-height: 1;
        transition: all 0.1s ease;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        white-space: nowrap;
      }
      
      .nav-button:hover:not(:disabled) {
        background: #e8f4fd;
        border-color: #0078d4;
      }
      
      .nav-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .breadcrumb {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem 0.75rem;
        background: white;
        border: 1px solid #ccc;
        border-radius: 3px;
        overflow-x: auto;
        min-height: 36px;
        white-space: nowrap;
      }
      
      .breadcrumb-item {
        color: #0078d4;
        cursor: pointer;
        white-space: nowrap;
      }
      
      .breadcrumb-item:hover {
        text-decoration: underline;
      }
      
      .breadcrumb-separator {
        color: #666;
        margin: 0 0.25rem;
      }

      .existing-file-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        margin-bottom: 0.5rem;
      }
      
      .file-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }
      
      .file-icon svg {
        width: 100%;
        height: 100%;
      }

      .existing-file-name {
        flex: 1;
        color: var(--concrete-gray);
        font-size: 0.95rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
      }

      .existing-file-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.8rem;
        color: var(--steel-gray);
        align-items: center;
      }
      
      .file-meta-item {
        min-width: 70px;
        text-align: left;
      }
      
      .file-meta-date {
        min-width: 100px;
      }

      .existing-file-category {
        display: none;
      }

      .existing-file-actions {
        display: flex;
        gap: 0.4rem;
        align-items: center;
        margin-left: auto;
      }

      .file-action-btn {
        padding: 0.3rem 0.6rem;
        border: 1px solid #d0d0d0;
        background: white;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.1s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
        white-space: nowrap;
        color: var(--concrete-gray);
      }

      .file-action-btn:hover {
        background: #f0f0f0;
        border-color: #999;
      }
      
      .file-details-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding-left: 28px;
      }
      
      .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        border-radius: 3px;
        padding: 0.25rem 0;
        z-index: 1000;
        display: none;
        min-width: 150px;
      }
      
      .context-menu.show {
        display: block;
      }
      
      .context-menu-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--concrete-gray);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .context-menu-item:hover {
        background: #e8f4fd;
      }
      
      .context-menu-separator {
        height: 1px;
        background: #e0e0e0;
        margin: 0.25rem 0;
      }

      .file-action-btn.reindex {
        background: var(--hi-vis-green);
        color: var(--dark-gray);
      }

      .file-action-btn.reindex:hover {
        background: #64dd17;
        transform: scale(1.05);
      }

      .no-files-message {
        text-align: center;
        padding: 2rem;
        color: var(--steel-gray);
        font-style: italic;
        background: var(--light-gray);
        border-radius: 8px;
        border: 2px dashed var(--medium-gray);
      }

      .loading-indicator {
        display: none;
        text-align: center;
        padding: 1.5rem;
        color: var(--steel-gray);
        background: var(--light-gray);
        border-radius: 8px;
        margin: 0.5rem 0;
      }

      .loading-indicator.active {
        display: block;
      }

      .loading-indicator::before {
        content: "‚è≥";
        font-size: 1.5rem;
        display: block;
        margin-bottom: 0.5rem;
        animation: pulse 1.5s infinite;
      }

      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: var(--light-gray);
        border-left: 4px solid var(--construction-orange);
        margin-bottom: 0.5rem;
        border-radius: 0 5px 5px 0;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .file-item .file-name {
        flex: 1;
        font-size: 0.9rem;
        color: var(--concrete-gray);
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .file-item .file-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .file-item .file-category {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        background: var(--construction-orange);
        color: white;
        border-radius: 3px;
        font-weight: 600;
      }

      .file-item .file-size {
        font-size: 0.8rem;
        color: var(--steel-gray);
      }

      .remove-file {
        background: var(--warning-red);
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.2s ease;
        font-weight: bold;
      }

      .remove-file:hover {
        background: #b71c1c;
        transform: scale(1.1);
      }

      .process-button {
        width: 100%;
        background: linear-gradient(
          135deg,
          var(--hi-vis-green) 0%,
          #64dd17 100%
        );
        color: var(--dark-gray);
        border: none;
        padding: 1rem;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 8px rgba(118, 255, 3, 0.3);
      }

      .process-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(118, 255, 3, 0.4);
      }

      .process-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--medium-gray);
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 150px);
        position: relative;
      }

      .chat-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--construction-orange);
      }

      .chat-header {
        background: linear-gradient(
          135deg,
          var(--concrete-gray) 0%,
          var(--steel-gray) 100%
        );
        color: white;
        padding: 1.5rem;
        border-radius: 10px 10px 0 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 4px solid var(--safety-yellow);
      }

      .chat-header h2 {
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .chat-header h2::before {
        content: "üë∑";
        font-size: 1.8rem;
      }

      .chat-messages {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .message {
        display: flex;
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        justify-content: flex-end;
      }

      .message.assistant .message-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(
          135deg,
          var(--safety-yellow) 0%,
          #f57f17 100%
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        font-size: 20px;
        color: var(--dark-gray);
      }

      .message-content {
        max-width: 70%;
        padding: 1rem 1.25rem;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .message.user .message-content {
        background: linear-gradient(
          135deg,
          #ffab70 0%,
          #ff8a50 100%
        );
        color: white;
        border-bottom-right-radius: 3px;
      }

      .message.user .message-time {
        color: #2c2c2c;
        font-weight: 500;
      }

      .message.assistant .message-content {
        background: white;
        color: var(--concrete-gray);
        border-bottom-left-radius: 3px;
        border: 1px solid var(--medium-gray);
      }

      /* Enhanced message content styling */
      .message-content .formatted-content {
        line-height: 1.6;
        word-wrap: break-word;
      }

      .message-content .formatted-content a {
        color: var(--blueprint-blue);
        text-decoration: underline;
        word-break: break-all;
        transition: color 0.2s ease;
      }

      .message-content .formatted-content a:hover {
        color: var(--construction-orange);
      }

      .message-content .formatted-content strong {
        font-weight: 600;
        color: var(--concrete-gray);
      }

      .message-content .formatted-content em {
        font-style: italic;
        color: var(--steel-gray);
      }

      .message-content .formatted-content p {
        margin-bottom: 0.75rem;
      }

      .message-content .formatted-content p:last-child {
        margin-bottom: 0;
      }

      .message-content .formatted-content ul,
      .message-content .formatted-content ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
      }

      .message-content .formatted-content li {
        margin-bottom: 0.25rem;
      }

      .message-content .formatted-content hr {
        border: none;
        border-top: 2px solid var(--medium-gray);
        margin: 1rem 0;
        opacity: 0.5;
      }

      .message-time {
        font-size: 0.75rem;
        color: #95a5a6;
        margin-top: 0.5rem;
      }

      .chat-input-container {
        padding: 1.5rem;
        background: white;
        border-radius: 0 0 10px 10px;
        border-top: 2px solid var(--medium-gray);
      }

      .ai-disclaimer {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 1px solid #ffc107;
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--dark-gray);
      }

      .disclaimer-icon {
        font-size: 1rem;
        flex-shrink: 0;
      }

      .disclaimer-text {
        line-height: 1.4;
      }

      .disclaimer-text strong {
        color: #d68910;
        font-weight: 600;
      }

      .chat-input-wrapper {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .chat-context-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        background: var(--light-gray);
        border-radius: 8px;
        border: 1px solid var(--medium-gray);
      }

      .chat-context-selector label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--concrete-gray);
        white-space: nowrap;
      }

      .chat-context-selector select {
        padding: 0.5rem;
        border: 1px solid var(--medium-gray);
        border-radius: 5px;
        font-size: 0.9rem;
        background: white;
        color: var(--concrete-gray);
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
      }

      .chat-context-selector select:hover {
        border-color: var(--construction-orange);
      }

      .chat-context-selector select:focus {
        outline: none;
        border-color: var(--construction-orange);
        box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
      }

      .chat-input-row {
        display: flex;
        gap: 1rem;
        align-items: center;
        width: 100%;
      }

      .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid var(--medium-gray);
        border-radius: 25px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .chat-input:focus {
        outline: none;
        border-color: var(--construction-orange);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
      }

      .send-button {
        background: linear-gradient(
          135deg,
          #ffab70 0%,
          #ff8a50 100%
        );
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
      }

      .send-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(255, 171, 112, 0.3);
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--medium-gray);
      }

      .typing-indicator {
        display: none;
        align-items: center;
        gap: 0.25rem;
        padding: 1rem;
        background: white;
        border-radius: 10px;
        width: fit-content;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-left: 3.5rem;
      }

      .typing-indicator.active {
        display: flex;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--construction-orange);
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(1);
          opacity: 0.5;
        }
        40% {
          transform: scale(1.3);
          opacity: 1;
        }
      }

      .metadata-panel {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: white;
        border-radius: 10px;
        border: 2px solid var(--construction-orange);
        box-shadow: var(--shadow-lg);
      }

      .metadata-panel h3 {
        margin-bottom: 1rem;
        color: var(--concrete-gray);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
      }

      .metadata-panel h3::before {
        content: "üìä";
        font-size: 1.5rem;
      }

      .metadata-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        border-bottom: 1px solid var(--medium-gray);
        background: var(--light-gray);
        margin-bottom: 0.5rem;
        border-radius: 5px;
      }

      .metadata-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }

      .metadata-label {
        font-weight: 600;
        color: var(--concrete-gray);
        font-size: 0.95rem;
      }

      .metadata-value {
        color: var(--steel-gray);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .metadata-value.status-active {
        color: var(--hi-vis-green);
        font-weight: bold;
      }

      .progress-bar {
        width: 100%;
        height: 30px;
        background: var(--medium-gray);
        border-radius: 15px;
        overflow: hidden;
        margin-top: 1rem;
        display: none;
        border: 2px solid var(--steel-gray);
      }

      .progress-bar.active {
        display: block;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--construction-orange),
          var(--safety-yellow)
        );
        border-radius: 13px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--dark-gray);
        font-weight: bold;
      }

      .error-message {
        background: linear-gradient(135deg, var(--warning-red), #b71c1c);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
      }

      .error-message.show {
        display: block;
        animation: slideIn 0.3s ease-out;
      }

      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
          padding: 1rem;
        }

        .sidebar {
          order: 2;
        }

        .chat-container {
          height: 500px;
          order: 1;
        }

        .message-content {
          max-width: 85%;
        }

        .category-item {
          padding: 0.75rem;
        }

        .category-files {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .logo-icon {
          width: 80px;
          height: 80px;
        }

        .logo h1 {
          font-size: 1.8rem;
        }
      }
    </style>
    <style>
      /* Embedded PDF Viewer styles */
      .pdf-viewer-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.65);
        z-index: 9999;
        backdrop-filter: blur(2px);
      }
      .pdf-viewer-overlay.active { display: block; }

      .pdf-viewer-container {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 92%;
        max-width: 1400px;
        height: 86vh;
        background: #ffffff;
        border-radius: 10px;
        z-index: 10000;
        box-shadow: var(--shadow-lg);
        border: 3px solid var(--construction-orange);
        overflow: hidden;
      }
      .pdf-viewer-container.active {
        display: flex;
        flex-direction: column;
      }

      .pdf-viewer-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        padding: 0.6rem 0.9rem;
        background: linear-gradient(135deg, var(--concrete-gray), var(--steel-gray));
        color: #fff;
        border-bottom: 4px solid var(--safety-yellow);
      }
      .pdf-viewer-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
      }
      .pdf-viewer-controls {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        flex-wrap: wrap;
      }
      .viewer-btn {
        padding: 0.35rem 0.6rem;
        border: 1px solid rgba(255,255,255,0.3);
        background: rgba(255,255,255,0.12);
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
      }
      .viewer-btn:hover { background: rgba(255,255,255,0.2); }
      .viewer-sep { width: 1px; height: 22px; background: rgba(255,255,255,0.3); margin: 0 4px; }
      .viewer-info { font-size: 0.85rem; color: #f0f0f0; padding: 0 6px; }

      .pdf-viewer-body { flex: 1; display: flex; background: #f3f3f3; }
      .pdf-viewer-iframe { width: 100%; height: 100%; border: 0; background: #f3f3f3; }

      /* Button shown in chat to open drawings */
      .drawing-preview-thumb {
        background: linear-gradient(135deg, var(--safety-yellow) 0%, #f57f17 100%);
        color: var(--dark-gray);
        border: none;
        padding: 0.5rem 0.9rem;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        margin: 0.25rem 0.25rem 0.25rem 0;
      }
      .drawing-preview-thumb:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        background: linear-gradient(135deg, #f57f17 0%, var(--safety-yellow) 100%);
      }
      .drawing-preview-thumb:active { transform: translateY(0); }

      @media (max-width: 768px) {
        .pdf-viewer-container { width: 96%; height: 80vh; }
        .pdf-viewer-title { font-size: 0.95rem; }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo">
        <div class="logo-icon">
          <img
            src="ForemanAI.png"
            alt="Ask Foreman"
          />
        </div>
        <div>
          <h1>ASK FOREMAN AI</h1>
          <p class="tagline">SAX Technology Advisors</p>
        </div>
      </div>
      <div style="display: flex; align-items: center;">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>System Online</span>
        </div>
        <a href="admin.html" class="maintenance-btn">
          üõ†Ô∏è Maintenance
        </a>
      </div>
    </header>

    <div class="container">
      <aside class="sidebar">
        <div class="card">
          <div class="client-selector">
            <label for="clientSelect">üè¢ Select Client Project:</label>
            <select id="clientSelect">
              <option value="">Loading clients...</option>
            </select>
          </div>

          <div class="document-categories">
            <h3>Document Upload Center</h3>
            <div class="category-group">
              <div class="category-item">
                <div class="category-header">
                  <input
                    type="checkbox"
                    id="drawings"
                    value="drawings"
                  />
                  <label for="drawings">üìê Drawings & Plans</label>
                </div>
                <div class="category-files">
                  <div class="file-input-wrapper">
                    <input
                      type="file"
                      id="drawingsFiles"
                      multiple
                      accept=".pdf,.docx,.xlsx,.xls"
                      data-category="drawings"
                    />
                    <button
                      class="choose-files-btn"
                      onclick="document.getElementById('drawingsFiles').click()"
                    >
                      Choose Files
                    </button>
                  </div>
                  <span class="file-count" id="drawingsCount">0 files</span>
                </div>
              </div>

              <div class="category-item">
                <div class="category-header">
                  <input
                    type="checkbox"
                    id="estimates"
                    value="estimates"
                  />
                  <label for="estimates">üí∞ Estimates</label>
                </div>
                <div class="category-files">
                  <div class="file-input-wrapper">
                    <input
                      type="file"
                      id="estimatesFiles"
                      multiple
                      accept=".pdf,.docx,.xlsx,.xls"
                      data-category="estimates"
                    />
                    <button
                      class="choose-files-btn"
                      onclick="document.getElementById('estimatesFiles').click()"
                    >
                      Choose Files
                    </button>
                  </div>
                  <span class="file-count" id="estimatesCount">0 files</span>
                </div>
              </div>

              <div class="category-item">
                <div class="category-header">
                  <input
                    type="checkbox"
                    id="proposals"
                    value="proposals"
                  />
                  <label for="proposals">üìä Proposals</label>
                </div>
                <div class="category-files">
                  <div class="file-input-wrapper">
                    <input
                      type="file"
                      id="proposalsFiles"
                      multiple
                      accept=".pdf,.docx,.xlsx,.xls"
                      data-category="proposals"
                    />
                    <button
                      class="choose-files-btn"
                      onclick="document.getElementById('proposalsFiles').click()"
                    >
                      Choose Files
                    </button>
                  </div>
                  <span class="file-count" id="proposalsCount">0 files</span>
                </div>
              </div>

              <div class="category-item">
                <div class="category-header">
                  <input type="checkbox" id="specs" value="specs" />
                  <label for="specs">üìã Specs</label>
                </div>
                <div class="category-files">
                  <div class="file-input-wrapper">
                    <input
                      type="file"
                      id="specsFiles"
                      multiple
                      accept=".pdf,.docx,.xlsx,.xls"
                      data-category="specs"
                    />
                    <button
                      class="choose-files-btn"
                      onclick="document.getElementById('specsFiles').click()"
                    >
                      Choose Files
                    </button>
                  </div>
                  <span class="file-count" id="specsCount">0 files</span>
                </div>
              </div>

              <div class="category-item">
                <div class="category-header">
                  <input type="checkbox" id="signed-contracts" value="signed-contracts" />
                  <label for="signed-contracts">üìù Signed Contracts</label>
                </div>
                <div class="category-files">
                  <div class="file-input-wrapper">
                    <input
                      type="file"
                      id="signed-contractsFiles"
                      multiple
                      accept=".pdf,.docx,.xlsx,.xls"
                      data-category="signed-contracts"
                    />
                    <button
                      class="choose-files-btn"
                      onclick="document.getElementById('signed-contractsFiles').click()"
                    >
                      Choose Files
                    </button>
                  </div>
                  <span class="file-count" id="signed-contractsCount">0 files</span>
                </div>
              </div>
            </div>
          </div>

          <div class="file-list" id="fileList">
            <div class="loading-indicator" id="filesLoadingIndicator">
              Loading existing files...
            </div>
          </div>

          <div class="error-message" id="errorMessage"></div>

          <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill">0%</div>
          </div>

          <button
            class="process-button"
            id="processButton"
            disabled
          >
            üöß Process Documents
          </button>

          <button
            class="process-button"
            id="createClientButton"
            style="
              background: linear-gradient(
                135deg,
                var(--safety-yellow),
                #f57f17
              );
              color: var(--dark-gray);
              margin-top: 0.5rem;
            "
          >
            ‚ûï Create New Client
          </button>
        </div>

        <div class="card metadata-panel">
          <h3>Index Status</h3>
          <div class="metadata-item">
            <span class="metadata-label">Documents:</span>
            <span class="metadata-value" id="docCount">0</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Index Size:</span>
            <span class="metadata-value" id="indexSize">0 MB</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Last Updated:</span>
            <span class="metadata-value" id="lastUpdated">Never</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Status:</span>
            <span class="metadata-value status-active" id="indexStatus"
              >Ready</span
            >
          </div>
        </div>
      </aside>

      <main class="card chat-container">
        <div class="chat-header">
          <h2>Construction AI Assistant</h2>
          <span style="font-size: 0.9rem; opacity: 0.8"
            >Powered by SAX Technology Advisors</span
          >
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message assistant">
            <div class="message-avatar">üî®</div>
            <div class="message-content">
              <div class="formatted-content">
                <p><strong>Hi, I'm your AI Foreman!</strong></p>
                <p>
                  I'm ready to help with construction estimating, specifications,
                  and project questions. I can assist with:
                </p>
                <ul>
                  <li>Paint scope, quantities, and color schedules</li>
                  <li>Floor coatings and finish specifications</li>
                  <li>Room schedules and area calculations</li>
                  <li>Material specifications and building codes</li>
                  <li>Door/frame schedules and hardware</li>
                  <li>Structural steel and CMU calculations</li>
                  <li>Cost estimates and construction takeoffs</li>
                </ul>
                <p>
                  <strong>üí° Pro tip:</strong> Use the "Focus on" dropdown below
                  to search specific project documents, or keep it on "General"
                  for industry knowledge. The upload section above is for adding
                  NEW documents to the system.
                </p>
              </div>
              <div class="message-time">Just now</div>
            </div>
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>

        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <div class="chat-context-selector">
              <label for="chatClientSelect">üéØ Focus on:</label>
              <select id="chatClientSelect">
                <option value="general">General Construction Knowledge</option>
              </select>
            </div>
            <div class="chat-input-row">
              <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="Ask about construction estimating, specifications, or any project questions..."
              />
              <button class="send-button" id="sendButton">
                <span>Send</span>
                <span>‚Üí</span>
              </button>
            </div>
          </div>

          <!-- AI Disclaimer -->
          <div class="ai-disclaimer">
            <span class="disclaimer-icon">‚ö†Ô∏è</span>
            <span class="disclaimer-text">
              Ask Foreman AI <strong>can make mistakes</strong> and you should verify important information.
            </span>
          </div>
        </div>
      </main>
    </div>

    <!-- Embedded PDF Viewer Overlay -->
    <div id="pdfViewerOverlay" class="pdf-viewer-overlay" onclick="closePdfViewer()"></div>
    <div id="pdfViewerContainer" class="pdf-viewer-container" role="dialog" aria-modal="true" aria-label="Document viewer">
      <div class="pdf-viewer-header">
        <div class="pdf-viewer-title">
          <span id="pdfViewerTitle">üìê Document Viewer</span>
        </div>
        <div class="pdf-viewer-controls">
          <button class="viewer-btn" title="Previous page" onclick="prevPage()">‚óÄ</button>
          <div class="viewer-info" id="pdfViewerPageInfo">Page 1</div>
          <button class="viewer-btn" title="Next page" onclick="nextPage()">‚ñ∂</button>
          <div class="viewer-sep"></div>
          <button class="viewer-btn" title="Zoom out" onclick="zoomOut()">‚àí</button>
          <div class="viewer-info" id="pdfViewerZoomInfo">100%</div>
          <button class="viewer-btn" title="Zoom in" onclick="zoomIn()">Ôºã</button>
          <div class="viewer-sep"></div>
          <button class="viewer-btn" title="Open in new tab" onclick="openInNewTab()">‚Üó</button>
          <button class="viewer-btn" title="Download" onclick="downloadPdf()">‚¨á</button>
          <button class="viewer-btn" style="background: #d32f2f; border-color: #d32f2f;" title="Close" onclick="closePdfViewer()">‚úï</button>
        </div>
      </div>
      <div class="pdf-viewer-body">
        <iframe id="pdfViewerFrame" class="pdf-viewer-iframe" src="" title="PDF Viewer"></iframe>
      </div>
    </div>

    <script>
      // Configuration - Production webhook URLs
      const API_CONFIG = {
        chatWebhookUrl:
          "https://workflows.saxtechnology.com/webhook/ask-foreman/chat",
        uploadWebhookUrl:
          "https://workflows.saxtechnology.com/webhook/ask-foreman/upload",
        createClientWebhookUrl:
          "https://workflows.saxtechnology.com/webhook/ask-foreman/clients/create",
        listClientsWebhookUrl:
          "https://workflows.saxtechnology.com/webhook/ask-foreman/clients/list",
        indexName: "construction-docs-index",
      };

      // Azure Blob Storage Configuration
      const AZURE_STORAGE = {
        account: "saxtechfcs",
        container: "fcs-clients",
        sasToken: "?sp=racwdl&st=2025-08-08T05:00:57Z&se=2030-08-08T13:15:57Z&spr=https&sv=2024-11-04&sr=c&sig=lJKK9jDZ59pJSNkKSgwaQIrCdBaJzx4XPzgEB2%2FrnIg%3D"
      };

      // File Management
      let uploadedFiles = {
        drawings: [],
        estimates: [],
        proposals: [],
        specs: [],
        "signed-contracts": [],
      };
      let processedDocuments = 0;
      let selectedClient = "";

      // DOM Elements
      const fileList = document.getElementById("fileList");
      const processButton = document.getElementById("processButton");
      const chatInput = document.getElementById("chatInput");
      const sendButton = document.getElementById("sendButton");
      const chatMessages = document.getElementById("chatMessages");
      const typingIndicator = document.getElementById("typingIndicator");
      const progressBar = document.getElementById("progressBar");
      const progressFill = document.getElementById("progressFill");
      const clientSelect = document.getElementById("clientSelect");
      const chatClientSelect = document.getElementById("chatClientSelect");
      const errorMessage = document.getElementById("errorMessage");
      const createClientButton = document.getElementById("createClientButton");

      // Track chat context separately from upload client
      let chatContext = "general";

      // Enhanced message formatting function
      function formatMessageContent(content) {
        if (!content) return '';
        
        // Ensure content is a string
        content = String(content);

        // Convert embedded viewer tokens into buttons BEFORE other formatting
        // Pattern: [VIEWER:url|filename|drawingNumber|scale|category]
        try {
          const btnClass = 'drawing-preview-thumb';
          const escAttr = (s) => String(s ?? '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
          const escText = (s) => String(s ?? '').replace(/[&<>]/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
          content = content.replace(/\[VIEWER:([^|]+)\|([^|]*)\|([^|]*)\|([^|]*)\|([^\]|]*)\]/g,
            (m, url, filename, number, scale, category) => {
              const label = filename || number || 'Document';
              return `<button class="${btnClass}" onclick="openDrawing('${escAttr(url)}','${escAttr(filename)}','${escAttr(number)}','${escAttr(scale)}','${escAttr(category)}',1)">üìê View ${escText(label)}</button>`;
            }
          );
        } catch (e) {
          console.warn('Viewer token parse failed:', e);
        }
        
        // Also detect and convert drawing/PDF links in square brackets format
        // Pattern: [filename.pdf](url)
        try {
          content = content.replace(/\[([^\]]+\.pdf)\]\((https?:\/\/[^)]+)\)/gi, (match, filename, url) => {
            const btnClass = 'drawing-preview-thumb';
            const escAttr = (s) => String(s ?? '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
            const escText = (s) => String(s ?? '').replace(/[&<>]/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
            // Extract drawing info from filename if possible
            const drawingMatch = filename.match(/([A-Z]+-?\d+[.]?\d*)/i);
            const drawingNumber = drawingMatch ? drawingMatch[1] : '';
            return `<button class="${btnClass}" onclick="openDrawing('${escAttr(url)}','${escAttr(filename)}','${escAttr(drawingNumber)}','','',1)">üìê View ${escText(filename)}</button>`;
          });
        } catch (e) {
          console.warn('PDF link conversion failed:', e);
        }
        
        // First, handle bullet points (convert - ** to proper bullets)
        content = content.replace(/- \*\*(.*?)\*\*/g, '‚Ä¢ **$1**');
        
        // Convert line breaks to proper HTML paragraphs
        content = content.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
        
        // Wrap in paragraph tags if not already wrapped
        if (!content.includes('<p>')) {
          content = '<p>' + content + '</p>';
        }
        
        // Convert markdown-style formatting BEFORE URL conversion
        content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
        
        // Convert URLs to clickable links with better styling
        const urlRegex = /(https?:\/\/[^\s<>]+)/g;
        content = content.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
        
        // Convert horizontal rules
        content = content.replace(/^---$/gm, '<hr>');
        
        // Handle bullet points better (convert ‚Ä¢ to proper list items)
        content = content.replace(/‚Ä¢ /g, '<br>‚Ä¢ ');
        
        // Handle source citations (make them stand out)
        content = content.replace(/üìé Source: (https?:\/\/[^\s<>]+)/g, 
          '<div style="margin: 0.5rem 0; padding: 0.5rem; background: var(--light-gray); border-left: 3px solid var(--blueprint-blue); border-radius: 3px;"><span style="font-size: 0.9rem; color: var(--steel-gray);">üìé Source:</span> <a href="$1" target="_blank" rel="noopener noreferrer" style="font-size: 0.9rem;">$1</a></div>');
        
        // Clean up any empty paragraphs
        content = content.replace(/<p><\/p>/g, '');
        content = content.replace(/<p><br><\/p>/g, '');
        
        return content;
      }

      // Enhanced addMessage function with better formatting
      function addMessage(content, sender) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        // Format the content for proper display
        const formattedContent = sender === "assistant" ? formatMessageContent(content) : escapeHtml(content);

        if (sender === "assistant") {
          messageDiv.innerHTML = `
            <div class="message-avatar">üî®</div>
            <div class="message-content">
              <div class="formatted-content">${formattedContent}</div>
              <div class="message-time">${time}</div>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="formatted-content">${formattedContent}</div>
              <div class="message-time">${time}</div>
            </div>
          `;
        }

        // Safely insert message before typing indicator
        try {
          if (typingIndicator && typingIndicator.parentNode === chatMessages) {
            chatMessages.insertBefore(messageDiv, typingIndicator);
          } else {
            chatMessages.appendChild(messageDiv);
          }
        } catch (error) {
          console.error("Error inserting message:", error);
          chatMessages.appendChild(messageDiv);
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Helper function to escape HTML for user messages
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Embedded PDF Viewer logic
      const pdfViewerState = {
        url: '',
        fileName: '',
        drawingNumber: '',
        scale: '',
        category: '',
        page: 1,
        zoom: 100
      };

      function buildPdfJsUrl(url, page, zoom) {
        const base = 'https://mozilla.github.io/pdf.js/web/viewer.html?file=' + encodeURIComponent(url);
        const hash = `#page=${page}&zoom=${zoom}`;
        return base + hash;
      }

      function updatePdfViewer() {
        const frame = document.getElementById('pdfViewerFrame');
        if (!frame) return;
        frame.src = buildPdfJsUrl(pdfViewerState.url, pdfViewerState.page, pdfViewerState.zoom);
        const pageInfo = document.getElementById('pdfViewerPageInfo');
        const zoomInfo = document.getElementById('pdfViewerZoomInfo');
        if (pageInfo) pageInfo.textContent = `Page ${pdfViewerState.page}`;
        if (zoomInfo) zoomInfo.textContent = `${pdfViewerState.zoom}%`;
      }

      function openDrawing(url, fileName = '', drawingNumber = '', scale = '', category = '', page = 1) {
        const overlay = document.getElementById('pdfViewerOverlay');
        const container = document.getElementById('pdfViewerContainer');
        const title = document.getElementById('pdfViewerTitle');
        
        pdfViewerState.url = decodeURIComponent(url);
        pdfViewerState.fileName = fileName || '';
        pdfViewerState.drawingNumber = drawingNumber || '';
        pdfViewerState.scale = scale || '';
        pdfViewerState.category = category || '';
        pdfViewerState.page = parseInt(page || 1, 10) || 1;
        pdfViewerState.zoom = 100;

        if (title) {
          const name = pdfViewerState.fileName || pdfViewerState.drawingNumber || 'Document';
          const meta = [pdfViewerState.drawingNumber, pdfViewerState.scale, pdfViewerState.category].filter(Boolean).join(' ‚Ä¢ ');
          title.textContent = `üìê ${name}` + (meta ? ` ‚Äî ${meta}` : '');
        }

        if (overlay) overlay.classList.add('active');
        if (container) container.classList.add('active');

        updatePdfViewer();
      }

      function closePdfViewer() {
        const overlay = document.getElementById('pdfViewerOverlay');
        const container = document.getElementById('pdfViewerContainer');
        const frame = document.getElementById('pdfViewerFrame');
        if (overlay) overlay.classList.remove('active');
        if (container) container.classList.remove('active');
        if (frame) frame.src = '';
      }

      function nextPage() {
        pdfViewerState.page = (pdfViewerState.page || 1) + 1;
        updatePdfViewer();
      }
      function prevPage() {
        pdfViewerState.page = Math.max(1, (pdfViewerState.page || 1) - 1);
        updatePdfViewer();
      }
      function zoomIn() {
        pdfViewerState.zoom = Math.min(300, (pdfViewerState.zoom || 100) + 25);
        updatePdfViewer();
      }
      function zoomOut() {
        pdfViewerState.zoom = Math.max(25, (pdfViewerState.zoom || 100) - 25);
        updatePdfViewer();
      }
      function openInNewTab() {
        const url = buildPdfJsUrl(pdfViewerState.url, pdfViewerState.page, pdfViewerState.zoom);
        window.open(url, '_blank', 'noopener');
      }
      function downloadPdf() {
        try {
          const a = document.createElement('a');
          a.href = pdfViewerState.url;
          a.download = pdfViewerState.fileName || 'document.pdf';
          document.body.appendChild(a);
          a.click();
          a.remove();
        } catch (e) {
          window.open(pdfViewerState.url, '_blank', 'noopener');
        }
      }

      // Create Client button handler
      createClientButton.addEventListener("click", () => {
        openCreateClientModal();
      });

      // Chat context selection handler
      chatClientSelect.addEventListener("change", async (e) => {
        chatContext = e.target.value;
        const contextName =
          chatClientSelect.options[chatClientSelect.selectedIndex].text;

        if (chatContext === "general") {
          addSystemMessage(
            "üåê Chat context set to General Construction Knowledge. I'll provide industry-standard guidance and best practices."
          );
          chatInput.placeholder =
            "Ask about construction estimating, specifications, or any project questions...";
          updateMetadata(); // Reset to defaults
        } else {
          addSystemMessage(
            `üéØ Chat context focused on ${contextName}. I'll prioritize information from this project's documents.`
          );
          chatInput.placeholder = `Ask about ${contextName} project details, specifications, or requirements...`;
          // Update metadata for the selected chat context
          await updateMetadataFromAzure(chatContext);
        }
      });

      // Client selection handler (for document uploads)
      clientSelect.addEventListener("change", async (e) => {
        if (e.target.value === 'retry') {
          await loadClients();
          return;
        }
        selectedClient = e.target.value;
        if (selectedClient) {
          addSystemMessage(
            `üìÅ Upload context set to "${
              clientSelect.options[clientSelect.selectedIndex].text
            }". New documents will be organized under this project.`
          );
          updateProcessButton();
          // Load existing files for this client
          await loadClientFiles(selectedClient);
          // Update metadata from Azure
          await updateMetadataFromAzure(selectedClient);
        } else {
          // Clear file list if no client selected
          initializeFileList();
          updateMetadata(); // Reset to defaults
        }
        updateChatAvailability();
      });

      // Setup file inputs for each category
      const categories = [
        "drawings",
        "estimates", 
        "proposals",
        "specs",
        "signed-contracts",
      ];

      categories.forEach((category) => {
        const inputId = category + "Files";
        const fileInput = document.getElementById(inputId);

        if (fileInput) {
          fileInput.addEventListener("change", (e) => {
            handleCategoryFiles(e.target.files, category);
          });
        }
      });

      function handleCategoryFiles(files, category) {
        // Auto-check the category checkbox when files are selected
        const checkboxId = category === "signed-contracts" ? "signed-contracts" : category;
        const checkbox = document.getElementById(checkboxId);
        if (checkbox && files.length > 0) {
          checkbox.checked = true;
        }
        
        for (let file of files) {
          if (isValidFile(file)) {
            const fileWithCategory = new File([file], file.name, {
              type: file.type,
            });
            fileWithCategory.category = category;
            uploadedFiles[category].push(fileWithCategory);
          } else {
            showError(
              `Invalid file type: ${file.name}. Please upload PDF, DOCX, or Excel files.`
            );
          }
        }
        updateFileCounts();
        renderFileList();
        updateProcessButton();
      }

      function isValidFile(file) {
        const validTypes = [".pdf", ".docx", ".xlsx", ".xls"];
        const extension = file.name
          .toLowerCase()
          .substring(file.name.lastIndexOf("."));
        return validTypes.includes(extension);
      }

      function updateFileCounts() {
        document.getElementById(
          "drawingsCount"
        ).textContent = `${uploadedFiles.drawings.length} files`;
        document.getElementById(
          "estimatesCount"
        ).textContent = `${uploadedFiles.estimates.length} files`;
        document.getElementById(
          "proposalsCount"
        ).textContent = `${uploadedFiles.proposals.length} files`;
        document.getElementById(
          "specsCount"
        ).textContent = `${uploadedFiles.specs.length} files`;
        document.getElementById(
          "signed-contractsCount"
        ).textContent = `${uploadedFiles["signed-contracts"].length} files`;
      }

      function renderFileList() {
        fileList.innerHTML = "";

        Object.keys(uploadedFiles).forEach((category) => {
          uploadedFiles[category].forEach((file) => {
            const fileItem = document.createElement("div");
            fileItem.className = "file-item";

            const categoryLabel =
              category.charAt(0).toUpperCase() + category.slice(1);

            fileItem.innerHTML = `
              <span class="file-name" title="${file.name}">${file.name}</span>
              <div class="file-info">
                <span class="file-category">${categoryLabel}</span>
                <span class="file-size">${formatFileSize(file.size)}</span>
                <button class="remove-file" onclick="removeFile('${
                  file.name
                }', '${category}')">√ó</button>
              </div>
            `;
            fileList.appendChild(fileItem);
          });
        });
      }

      function removeFile(fileName, category) {
        uploadedFiles[category] = uploadedFiles[category].filter(
          (file) => file.name !== fileName
        );
        updateFileCounts();
        renderFileList();
        updateProcessButton();
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i]
        );
      }

      function updateProcessButton() {
        const totalFiles = Object.values(uploadedFiles).reduce(
          (sum, files) => sum + files.length,
          0
        );
        const hasClient = selectedClient !== "";
        processButton.disabled = totalFiles === 0 || !hasClient;

        if (totalFiles > 0 && !hasClient) {
          processButton.textContent = "‚ö†Ô∏è Select Client First";
        } else {
          processButton.textContent = "üöß Process Documents";
        }
      }

      // System status checking (lightweight - no execution tokens)
      let systemStatus = {
        chat: true, // Assume online until proven otherwise
        upload: true,
        clients: true
      };

      // Simple network connectivity check (doesn't trigger n8n executions)
      async function checkSystemStatus() {
        const statusIndicator = document.querySelector('.status-indicator');
        const statusDot = document.querySelector('.status-dot');
        const statusText = statusIndicator.querySelector('span:last-child');
        
        try {
          // Simple network connectivity test to your domain (doesn't hit webhook endpoints)
          const connectivityTest = fetch('https://workflows.saxtechnology.com/', {
            method: 'HEAD',
            mode: 'no-cors', // Avoid CORS issues, just test connectivity
            cache: 'no-cache'
          }).then(() => true).catch(() => false);
          
          const isConnected = await Promise.race([
            connectivityTest,
            new Promise(resolve => setTimeout(() => resolve(false), 3000))
          ]);
          
          if (isConnected) {
            statusText.textContent = 'System Online';
            statusDot.style.background = 'var(--hi-vis-green)';
            statusDot.style.boxShadow = '0 0 10px var(--hi-vis-green)';
            statusIndicator.style.borderColor = 'var(--hi-vis-green)';
            statusIndicator.style.background = 'rgba(118, 255, 3, 0.1)';
            
            // Assume all services are online if network is reachable
            systemStatus.chat = true;
            systemStatus.clients = true;
            systemStatus.upload = true;
          } else {
            statusText.textContent = 'Network Offline';
            statusDot.style.background = 'var(--warning-red)';
            statusDot.style.boxShadow = '0 0 10px var(--warning-red)';
            statusIndicator.style.borderColor = 'var(--warning-red)';
            statusIndicator.style.background = 'rgba(211, 47, 47, 0.1)';
            
            systemStatus.chat = false;
            systemStatus.clients = false;
            systemStatus.upload = false;
          }
          
          updateChatAvailability();
          
        } catch (error) {
          console.error('Connectivity check failed:', error);
          statusText.textContent = 'Connection Error';
          statusDot.style.background = 'var(--warning-red)';
          statusDot.style.boxShadow = '0 0 10px var(--warning-red)';
          statusIndicator.style.borderColor = 'var(--warning-red)';
          statusIndicator.style.background = 'rgba(211, 47, 47, 0.1)';
        }
      }

      // Enhanced chat availability function
      function updateChatAvailability() {
        const isSystemOnline = systemStatus.chat;
        
        // Update chat input and button states
        chatInput.disabled = !isSystemOnline;
        sendButton.disabled = !isSystemOnline;
        
        if (!isSystemOnline) {
          chatInput.placeholder = "Network offline - chat unavailable";
          sendButton.style.opacity = '0.5';
        } else {
          // Update placeholder based on current chat context
          if (chatContext === "general") {
            chatInput.placeholder =
              "Ask about construction estimating, specifications, or any project questions...";
          } else {
            const contextName =
              chatClientSelect.options[chatClientSelect.selectedIndex].text;
            chatInput.placeholder = `Ask about ${contextName} project details, specifications, or requirements...`;
          }
          sendButton.style.opacity = '1';
        }
      }

      function showError(message) {
        const errorElement = document.getElementById("errorMessage");
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.add("show");
          setTimeout(() => {
            errorElement.classList.remove("show");
          }, 5000);
        } else {
          // Fallback if errorMessage element doesn't exist
          console.error("Error:", message);
          alert("Error: " + message);
        }
      }

      // Process Documents
      processButton.addEventListener("click", async () => {
        if (!selectedClient) {
          showError(
            "Please select a client project before processing documents."
          );
          return;
        }

        const allFiles = [];
        const selectedCategories = [];

        // Collect all files and active categories
        categories.forEach((category) => {
          const checkboxId = category === "signed-contracts" ? "signed-contracts" : category;
          const checkbox = document.getElementById(checkboxId);

          if (
            checkbox &&
            checkbox.checked &&
            uploadedFiles[category].length > 0
          ) {
            selectedCategories.push(category);
            allFiles.push(...uploadedFiles[category]);
          }
        });

        if (allFiles.length === 0) {
          showError(
            "Please select at least one category with files to process."
          );
          return;
        }

        processButton.disabled = true;
        progressBar.classList.add("active");

        let successCount = 0;
        let errorCount = 0;

        for (let i = 0; i < allFiles.length; i++) {
          const file = allFiles[i];
          const progress = Math.round(((i + 1) / allFiles.length) * 100);
          updateProgress(progress);

          try {
            await processFile(file, file.category);
            successCount++;
          } catch (error) {
            errorCount++;
            console.error(`Error processing ${file.name}:`, error);
          }
        }

        // Update metadata
        processedDocuments += successCount;
        updateMetadata();

        // Reset UI
        setTimeout(() => {
          progressBar.classList.remove("active");
          Object.keys(uploadedFiles).forEach((category) => {
            uploadedFiles[category] = [];
          });
          updateFileCounts();
          renderFileList();
          processButton.disabled = true;

          if (errorCount > 0) {
            addSystemMessage(
              `‚ö†Ô∏è Processed ${successCount} documents successfully, ${errorCount} failed. You can now ask questions about uploaded documents.`
            );
          } else {
            addSystemMessage(
              `‚úÖ All ${successCount} documents processed successfully for ${
                clientSelect.options[clientSelect.selectedIndex].text
              }! You can now ask questions about your construction documents.`
            );
          }
        }, 1000);
      });

      function updateProgress(percent) {
        progressFill.style.width = percent + "%";
        progressFill.textContent = percent + "%";
      }

      async function processFile(file, category) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("category", category);
        formData.append("client", selectedClient);

        try {
          const response = await fetch(API_CONFIG.uploadWebhookUrl, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const result = await response.json();
          return result;
        } catch (error) {
          console.error("Error processing file:", error);
          throw error;
        }
      }

      // Chat Functionality
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      sendButton.addEventListener("click", sendMessage);

      // Enhanced send message function with system status check
      async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        // Check if chat system is online
        if (!systemStatus.chat) {
          addSystemMessage("‚ö†Ô∏è Chat system is currently offline. Please wait for system to come back online.");
          return;
        }

        // Add user message
        addMessage(message, "user");

        // Clear input
        chatInput.value = "";

        // Show typing indicator
        typingIndicator.classList.add("active");
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
          const response = await fetch(API_CONFIG.chatWebhookUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              client: chatContext, // Use chat context instead of upload client
              conversationId: `conv_${chatContext}_${Date.now()}`,
              sessionId: chatContext,
            }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const data = await response.json();

          // Hide typing indicator
          typingIndicator.classList.remove("active");

          // Add assistant response with enhanced formatting
          addMessage(
            data.response ||
              "I received your message but couldn't generate a response. Please try again.",
            "assistant"
          );
        } catch (error) {
          typingIndicator.classList.remove("active");
          
          // Check if it's a network error
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            systemStatus.chat = false;
            checkSystemStatus(); // Recheck system status
            addMessage(
              "Network connection lost. The system appears to be offline. Please check your connection and try again.",
              "assistant"
            );
          } else {
            addMessage(
              "Sorry, I encountered an error processing your request. Please try again or contact support.",
              "assistant"
            );
          }
          
          console.error("Chat error:", error);
          showError(`Chat error: ${error.message}`);
        }
      }

      function addSystemMessage(content) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message assistant";

        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        messageDiv.innerHTML = `
          <div class="message-avatar">‚ö†Ô∏è</div>
          <div class="message-content" style="background: linear-gradient(135deg, var(--safety-yellow), #f57f17); color: var(--dark-gray);">
            <div class="formatted-content"><strong>${content}</strong></div>
            <div class="message-time">${time}</div>
          </div>
        `;

        // Safely insert system message
        try {
          if (typingIndicator && typingIndicator.parentNode === chatMessages) {
            chatMessages.insertBefore(messageDiv, typingIndicator);
          } else {
            chatMessages.appendChild(messageDiv);
          }
        } catch (error) {
          console.error("Error inserting system message:", error);
          chatMessages.appendChild(messageDiv);
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function updateMetadata(docCount = null, indexSize = null, lastUpdated = null, status = null) {
        // Use provided values or defaults
        document.getElementById("docCount").textContent = docCount !== null ? docCount : processedDocuments;
        
        if (indexSize !== null) {
          document.getElementById("indexSize").textContent = indexSize;
        } else {
          document.getElementById("indexSize").textContent = `${(
            (docCount || processedDocuments) * 0.5
          ).toFixed(1)} MB`;
        }
        
        document.getElementById("lastUpdated").textContent = lastUpdated || new Date().toLocaleString();
        
        if (status !== null) {
          document.getElementById("indexStatus").textContent = status;
        } else {
          const count = docCount !== null ? docCount : processedDocuments;
          document.getElementById("indexStatus").textContent = count > 0 ? "Active" : "Ready";
        }
      }
      
      // Pull live metadata from Azure for a client
      async function updateMetadataFromAzure(clientName) {
        try {
          // Only count files from FCS-OriginalClients in fcs-clients container
          const listUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=${encodeURIComponent('FCS-OriginalClients/' + clientName + '/')}`;
          
          const listResponse = await fetch(listUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/xml'
            }
          });
          
          if (listResponse.ok) {
            const xmlText = await listResponse.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const blobs = xmlDoc.getElementsByTagName("Blob");
            
            let totalSize = 0;
            let fileCount = 0;
            let lastModifiedDate = null;
            
            for (let i = 0; i < blobs.length; i++) {
              const nameElement = blobs[i].getElementsByTagName("Name")[0];
              if (nameElement && !nameElement.textContent.endsWith('.placeholder')) {
                fileCount++;
                
                const propertiesElement = blobs[i].getElementsByTagName("Properties")[0];
                if (propertiesElement) {
                  const sizeElement = propertiesElement.getElementsByTagName("Content-Length")[0];
                  if (sizeElement) {
                    totalSize += parseInt(sizeElement.textContent) || 0;
                  }
                  
                  const modifiedElement = propertiesElement.getElementsByTagName("Last-Modified")[0];
                  if (modifiedElement) {
                    const modDate = new Date(modifiedElement.textContent);
                    if (!lastModifiedDate || modDate > lastModifiedDate) {
                      lastModifiedDate = modDate;
                    }
                  }
                }
              }
            }
            
            updateMetadata(
              fileCount,
              `${(totalSize / (1024 * 1024)).toFixed(1)} MB`,
              lastModifiedDate ? lastModifiedDate.toLocaleString() : 'Never',
              fileCount > 0 ? 'Active' : 'Ready'
            );
          } else {
            // If list fails, just keep current display
            console.log('Could not fetch file list for metadata update');
          }
        } catch (error) {
          console.error('Error fetching Azure metadata:', error);
          // Keep current display if error
        }
      }

      // Create Client Modal functionality
      function openCreateClientModal() {
        // Create modal HTML
        const modalHTML = `
          <div id="clientModal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
          ">
            <div style="
              background: white;
              padding: 2rem;
              border-radius: 10px;
              width: 90%;
              max-width: 500px;
              box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            ">
              <h2 style="margin-bottom: 1.5rem; color: var(--concrete-gray);">üèóÔ∏è Create New Client</h2>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Client Name *</label>
                <input type="text" id="clientNameInput" placeholder="e.g. ABC Construction" style="
                  width: 100%;
                  padding: 0.75rem;
                  border: 2px solid var(--medium-gray);
                  border-radius: 5px;
                  font-size: 1rem;
                " />
              </div>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Project Type</label>
                <select id="projectTypeSelect" style="
                  width: 100%;
                  padding: 0.75rem;
                  border: 2px solid var(--medium-gray);
                  border-radius: 5px;
                  font-size: 1rem;
                ">
                  <option value="Commercial">Commercial</option>
                  <option value="Residential">Residential</option>
                  <option value="Industrial">Industrial</option>
                  <option value="Healthcare">Healthcare</option>
                  <option value="Educational">Educational</option>
                  <option value="Government">Government</option>
                  <option value="Infrastructure">Infrastructure</option>
                  <option value="Mixed-Use">Mixed-Use</option>
                </select>
              </div>
              
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Project Description</label>
                <textarea id="projectDescInput" placeholder="Brief description of the project..." style="
                  width: 100%;
                  padding: 0.75rem;
                  border: 2px solid var(--medium-gray);
                  border-radius: 5px;
                  font-size: 1rem;
                  min-height: 80px;
                  resize: vertical;
                "></textarea>
              </div>
              
              <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="closeClientModal()" style="
                  padding: 0.75rem 1.5rem;
                  border: 2px solid var(--medium-gray);
                  background: white;
                  color: var(--concrete-gray);
                  border-radius: 5px;
                  cursor: pointer;
                  font-weight: 600;
                ">Cancel</button>
                <button onclick="createClient()" style="
                  padding: 0.75rem 1.5rem;
                  border: none;
                  background: linear-gradient(135deg, var(--safety-yellow), #f57f17);
                  color: var(--dark-gray);
                  border-radius: 5px;
                  cursor: pointer;
                  font-weight: 600;
                ">Create Client</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.getElementById('clientNameInput').focus();
      }
      
      function closeClientModal() {
        const modal = document.getElementById('clientModal');
        if (modal) {
          modal.remove();
        }
      }
      
      async function createClient() {
        const clientName = document.getElementById('clientNameInput').value.trim();
        const projectType = document.getElementById('projectTypeSelect').value;
        const projectDescription = document.getElementById('projectDescInput').value.trim();
        
        if (!clientName) {
          alert('Client name is required');
          return;
        }
        
        // Show loading state in the create button
        const createBtn = event.target || document.querySelector('#clientModal button[onclick="createClient()"]');
        if (createBtn) {
          createBtn.disabled = true;
          createBtn.textContent = 'Creating client folders...';
        }
        
        try {
          console.log('Creating client:', { clientName, projectType });
          
          // Step 1: Call the webhook to create the client (this should handle n8n workflow)
          const response = await fetch(API_CONFIG.createClientWebhookUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              clientName: clientName,
              projectName: clientName, // Use client name as project name for backwards compatibility
              projectType: projectType,
              projectDescription: projectDescription
            }),
          });
          
          console.log('Create client response status:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('Create client error response:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText || 'Server error'}`);
          }
          
          let data;
          try {
            data = await response.json();
            console.log('Create client response data:', data);
          } catch (e) {
            console.warn('Response was not JSON, treating as success');
            data = { client: { id: clientName.replace(/\s+/g, '-') } };  // Keep original capitalization
          }
          
          // Step 2: Create folder structure in both containers
          if (createBtn) {
            createBtn.textContent = 'Setting up folders...';
          }
          
          // Create folders in fcs-clients container (for raw documents)
          const clientFolderName = clientName;
          const categories = ['drawings', 'estimates', 'proposals', 'specs', 'signed-contracts'];
          
          // Create placeholder files in each category folder in fcs-clients
          for (const category of categories) {
            const placeholderPath = `FCS-OriginalClients/${clientFolderName}/${category}/.placeholder`;
            await createPlaceholderFile('fcs-clients', placeholderPath);
          }
          
          // Create folder structure in fcs-convertedclients (for converted data and metadata)
          const convertedCategories = ['converted', 'metadata', 'chunks', 'embeddings', 'index'];
          for (const category of convertedCategories) {
            const placeholderPath = `${clientFolderName}/${category}/.placeholder`;
            await createPlaceholderFile('fcs-convertedclients', placeholderPath);
          }
          
          // Create initial metadata file in fcs-convertedclients
          const metadata = {
            clientName: clientName,
            projectType: projectType,
            projectDescription: projectDescription,
            createdAt: new Date().toISOString(),
            documentsCount: 0,
            lastUpdated: new Date().toISOString(),
            categories: categories,
            indexStatus: 'initialized'
          };
          
          await createMetadataFile('fcs-convertedclients', `${clientFolderName}/metadata/client-info.json`, metadata);
          
          // Close modal
          closeClientModal();
          
          // Add success message
          addSystemMessage(`‚úÖ Client "${clientName}" created successfully! Folders have been set up in both storage containers.`);
          
          // Wait a moment for Azure to process, then reload clients
          setTimeout(async () => {
            await loadClients();
            
            // Try to set the new client as selected
            const clientId = data.client?.folderName || data.client?.id || clientName;
            
            // Check if the client appears in the dropdown
            const options = Array.from(clientSelect.options);
            const clientOption = options.find(opt => 
              opt.value === clientId || 
              opt.value === clientName ||
              opt.value.toLowerCase() === clientId.toLowerCase()
            );
            
            if (clientOption) {
              clientSelect.value = clientOption.value;
              selectedClient = clientOption.value;
              addSystemMessage(`‚úÖ Client "${clientName}" is now selected and ready for document uploads.`);
            } else {
              console.log('Client not found in dropdown yet, it may take a moment to appear');
              addSystemMessage(`‚ö†Ô∏è Client "${clientName}" was created but may take a moment to appear in the list. Please refresh the page if it doesn't appear shortly.`);
            }
            
            updateProcessButton();
          }, 3000); // Wait 3 seconds for Azure to create the folders
          
        } catch (error) {
          console.error('Create client error:', error);
          alert(`Error creating client: ${error.message}`);
          
          // Re-enable the create button
          if (createBtn) {
            createBtn.disabled = false;
            createBtn.textContent = 'Create Client';
          }
        }
      }
      
      // Helper function to create placeholder files in Azure Blob Storage
      async function createPlaceholderFile(containerName, path) {
        try {
          // Encode path segments properly
          const pathSegments = path.split('/');
          const encodedPath = pathSegments.map(segment => encodeURIComponent(segment)).join('/');
          
          const placeholderUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${containerName}/${encodedPath}${AZURE_STORAGE.sasToken}`;
          
          const response = await fetch(placeholderUrl, {
            method: 'PUT',
            headers: {
              'x-ms-blob-type': 'BlockBlob',
              'Content-Type': 'text/plain',
              'Content-Length': '0'
            },
            body: '' // Empty placeholder file
          });
          
          if (!response.ok && response.status !== 201) {
            console.warn(`Failed to create placeholder at ${path}: ${response.status}`);
          } else {
            console.log(`Created placeholder: ${containerName}/${path}`);
          }
        } catch (error) {
          console.error(`Error creating placeholder file: ${error.message}`);
        }
      }
      
      // Helper function to create metadata JSON file in Azure Blob Storage
      async function createMetadataFile(containerName, path, metadata) {
        try {
          // Encode path segments properly
          const pathSegments = path.split('/');
          const encodedPath = pathSegments.map(segment => encodeURIComponent(segment)).join('/');
          
          const metadataUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${containerName}/${encodedPath}${AZURE_STORAGE.sasToken}`;
          
          const metadataContent = JSON.stringify(metadata, null, 2);
          
          const response = await fetch(metadataUrl, {
            method: 'PUT',
            headers: {
              'x-ms-blob-type': 'BlockBlob',
              'Content-Type': 'application/json',
              'Content-Length': new Blob([metadataContent]).size.toString()
            },
            body: metadataContent
          });
          
          if (!response.ok && response.status !== 201) {
            console.warn(`Failed to create metadata at ${path}: ${response.status}`);
          } else {
            console.log(`Created metadata: ${containerName}/${path}`);
          }
        } catch (error) {
          console.error(`Error creating metadata file: ${error.message}`);
        }
      }
      
      async function loadClients() {
        try {
          // Show loading state in dropdowns
          clientSelect.innerHTML = '<option value="">Loading clients...</option>';
          
          const clients = [];
          const clientSet = new Set(); // To avoid duplicates
          
          // First, check if there's an FCS-OriginalClients folder
          const topLevelUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&delimiter=/`;
          
          let response = await fetch(topLevelUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/xml'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          let xmlText = await response.text();
          console.log('Top-level Azure Blob Response:', xmlText); // Debug log
          
          // Parse the XML response
          const parser = new DOMParser();
          let xmlDoc = parser.parseFromString(xmlText, "text/xml");
          
          // Check if FCS-OriginalClients folder exists
          const topLevelPrefixes = xmlDoc.getElementsByTagName("BlobPrefix");
          let hasFCSFolder = false;
          
          for (let i = 0; i < topLevelPrefixes.length; i++) {
            const nameElement = topLevelPrefixes[i].getElementsByTagName("Name")[0];
            if (nameElement && nameElement.textContent === 'FCS-OriginalClients/') {
              hasFCSFolder = true;
              break;
            }
          }
          
          // If FCS-OriginalClients exists, list its contents
          if (hasFCSFolder) {
            const fcsUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=FCS-OriginalClients/&delimiter=/`;
            
            response = await fetch(fcsUrl, {
              method: 'GET',
              headers: {
                'Accept': 'application/xml'
              }
            });
            
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            xmlText = await response.text();
            console.log('FCS-OriginalClients contents:', xmlText); // Debug log
            
            // Parse the FCS folder contents
            xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const fcsPrefixes = xmlDoc.getElementsByTagName("BlobPrefix");
            
            for (let i = 0; i < fcsPrefixes.length; i++) {
              const nameElement = fcsPrefixes[i].getElementsByTagName("Name")[0];
              if (nameElement) {
                const fullPath = nameElement.textContent.replace(/\/$/, ''); // Remove trailing slash
                const pathParts = fullPath.split('/');
                
                // Get the client name (should be the second part after FCS-OriginalClients)
                if (pathParts.length >= 2 && pathParts[0] === 'FCS-OriginalClients') {
                  const clientName = pathParts[1];
                  
                  // Skip if already added or if it's a system folder
                  if (!clientSet.has(clientName) && !clientName.startsWith('.') && clientName.length > 0) {
                    clientSet.add(clientName);
                    clients.push({
                      id: clientName,  // Keep original capitalization for folder name
                      name: formatClientName(clientName)
                    });
                  }
                }
              }
            }
          } else {
            // If no FCS-OriginalClients folder, check top-level folders
            for (let i = 0; i < topLevelPrefixes.length; i++) {
              const nameElement = topLevelPrefixes[i].getElementsByTagName("Name")[0];
              if (nameElement) {
                const folderName = nameElement.textContent.replace(/\/$/, ''); // Remove trailing slash
                
                // Skip system folders or hidden folders
                if (!folderName.startsWith('.') && folderName.length > 0 && folderName !== 'FCS-OriginalClients') {
                  clients.push({
                    id: folderName,  // Keep original capitalization for folder name
                    name: formatClientName(folderName)
                  });
                }
              }
            }
          }
          
          // If no blob prefixes found, try getting individual blobs and extract unique folder names
          if (clients.length === 0) {
            const blobs = xmlDoc.getElementsByTagName("Blob");
            const uniqueClients = new Set();
            
            for (let i = 0; i < blobs.length; i++) {
              const nameElement = blobs[i].getElementsByTagName("Name")[0];
              if (nameElement) {
                const fullPath = nameElement.textContent;
                const pathParts = fullPath.split('/');
                
                // Check if this is under FCS-OriginalClients folder
                if (pathParts[0] === 'FCS-OriginalClients' && pathParts.length >= 2) {
                  const clientName = pathParts[1]; // Get the client name (second part)
                  
                  if (clientName && !clientName.startsWith('.')) {
                    uniqueClients.add(clientName);
                  }
                }
              }
            }
            
            uniqueClients.forEach(clientName => {
              clients.push({
                id: clientName,  // Keep original capitalization for folder name
                name: formatClientName(clientName)
              });
            });
          }
          
          // Sort clients alphabetically
          clients.sort((a, b) => a.name.localeCompare(b.name));
          
          // Update the dropdowns with Azure Storage clients
          updateClientDropdowns(clients);
          
          console.log(`Loaded ${clients.length} clients from Azure Blob Storage`);
          
          // Store clients for later use
          window.availableClients = clients;
          
        } catch (error) {
          console.error('Error loading clients from Azure:', error);
          
          // Show error state
          clientSelect.innerHTML = '<option value="">-- Error loading clients --</option>';
          
          // Add a retry option
          const retryOption = document.createElement('option');
          retryOption.value = 'retry';
          retryOption.textContent = 'Click to retry...';
          clientSelect.appendChild(retryOption);
          
          // Show error message to user
          showError(`Failed to load clients from Azure Storage: ${error.message}`);
        }
      }
      
      // Format client name for display
      function formatClientName(name) {
        // Handle different naming conventions
        // Example: "Baruch" stays "Baruch", "smith" becomes "Smith"
        return name
          .split(/[-_]/) // Split by dash or underscore
          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
          .join(' ');
      }
      
      function updateClientDropdowns(clients) {
        // Update upload client dropdown
        const currentUploadValue = clientSelect.value;
        clientSelect.innerHTML = '<option value="">-- Choose a Client --</option>';
        
        // Update chat client dropdown  
        const currentChatValue = chatClientSelect.value;
        const generalOption = chatClientSelect.querySelector('option[value="general"]');
        chatClientSelect.innerHTML = '';
        chatClientSelect.appendChild(generalOption); // Keep general option
        
        clients.forEach(client => {
          // Upload dropdown
          const uploadOption = document.createElement('option');
          uploadOption.value = client.id;
          uploadOption.textContent = client.name;
          clientSelect.appendChild(uploadOption);
          
          // Chat dropdown
          const chatOption = document.createElement('option');
          chatOption.value = client.id;
          chatOption.textContent = client.name;
          chatClientSelect.appendChild(chatOption);
        });
        
        // Restore previous selections if they still exist
        if (currentUploadValue && clientSelect.querySelector(`option[value="${currentUploadValue}"]`)) {
          clientSelect.value = currentUploadValue;
        }
        if (currentChatValue && chatClientSelect.querySelector(`option[value="${currentChatValue}"]`)) {
          chatClientSelect.value = currentChatValue;
        }
      }

      // Initialize system with lightweight status check
      window.addEventListener("load", async () => {
        try {
          // Lightweight connectivity check (no n8n executions)
          await checkSystemStatus();
          
          updateFileCounts();
          updateMetadata();

          // Initialize file list with default message
          initializeFileList();
          
          // Load existing clients (only if system is online)
          if (systemStatus.clients) {
            await loadClients();
          }
          
          // Set up periodic connectivity checks (every 5 minutes - much less frequent)
          setInterval(checkSystemStatus, 300000);
          
        } catch (error) {
          console.error("Initialization error:", error);
        }
      });

      function initializeFileList() {
        const fileList = document.getElementById("fileList");
        const loadingIndicator = document.getElementById(
          "filesLoadingIndicator"
        );

        if (fileList && loadingIndicator) {
          fileList.innerHTML = "";
          fileList.appendChild(loadingIndicator);

          const noClientMessage = document.createElement("div");
          noClientMessage.className = "no-files-message";
          noClientMessage.innerHTML =
            "üìÅ Select a client project above to view existing files and upload new documents.";
          fileList.appendChild(noClientMessage);
        }
      }
      
      // File browser state
      let currentPath = [];
      let fileStructure = {};
      let selectedFiles = new Set();
      
      // Build hierarchical file structure from flat file list
      function buildFileStructure(files) {
        const structure = {};
        
        files.forEach(file => {
          const pathParts = file.fullPath.split('/');
          // Remove the client prefix parts (FCS-OriginalClients/ClientName/)
          const relevantParts = pathParts.slice(2);
          
          let current = structure;
          
          relevantParts.forEach((part, index) => {
            if (index === relevantParts.length - 1) {
              // It's a file
              if (!current._files) current._files = [];
              current._files.push({
                ...file,
                name: part
              });
            } else {
              // It's a folder
              if (!current[part]) {
                current[part] = {};
              }
              current = current[part];
            }
          });
        });
        
        return structure;
      }
      
      // Get current folder content based on path
      function getCurrentFolder() {
        let current = fileStructure;
        currentPath.forEach(folder => {
          current = current[folder];
        });
        return current;
      }
      
      // Navigate to a folder
      function navigateToFolder(folderName) {
        currentPath.push(folderName);
        renderFileBrowser();
      }
      
      // Navigate back
      function navigateBack() {
        if (currentPath.length > 0) {
          currentPath.pop();
          renderFileBrowser();
        }
      }
      
      // Navigate to specific path level
      function navigateToPath(pathIndex) {
        currentPath = currentPath.slice(0, pathIndex);
        renderFileBrowser();
      }
      
      // Handle file/folder click
      function handleItemClick(event, itemName, isFolder) {
        const item = event.currentTarget;
        
        if (event.detail === 2) {
          // Double click
          if (isFolder) {
            navigateToFolder(itemName);
          } else {
            // Open file
            openFile(itemName);
          }
        } else {
          // Single click - selection
          if (event.ctrlKey || event.metaKey) {
            // Multi-select
            item.classList.toggle('selected');
            if (item.classList.contains('selected')) {
              selectedFiles.add(itemName);
            } else {
              selectedFiles.delete(itemName);
            }
          } else {
            // Single select
            document.querySelectorAll('.existing-file-item, .folder-item').forEach(el => {
              el.classList.remove('selected');
            });
            selectedFiles.clear();
            item.classList.add('selected');
            selectedFiles.add(itemName);
          }
        }
      }
      
      // Right-click context menu
      function showContextMenu(event, itemName, isFolder) {
        event.preventDefault();
        
        // Remove existing context menu if any
        const existingMenu = document.querySelector('.context-menu');
        if (existingMenu) existingMenu.remove();
        
        const menu = document.createElement('div');
        menu.className = 'context-menu show';
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        
        if (isFolder) {
          menu.innerHTML = `
            <div class="context-menu-item" onclick="navigateToFolder('${itemName}'); closeContextMenu();">üìÇ Open</div>
            <div class="context-menu-item" onclick="openInNewTab('${itemName}', true); closeContextMenu();">üóÇÔ∏è Open in new tab</div>
            <div class="context-menu-separator"></div>
            <div class="context-menu-item" onclick="renameItem('${itemName}', true); closeContextMenu();">‚úèÔ∏è Rename</div>
            <div class="context-menu-item" onclick="deleteFolder('${itemName}'); closeContextMenu();">üóëÔ∏è Delete</div>
          `;
        } else {
          const currentFolder = getCurrentFolder();
          const file = currentFolder._files.find(f => f.name === itemName);
          
          menu.innerHTML = `
            <div class="context-menu-item" onclick="openFile('${itemName}'); closeContextMenu();">üìÑ Open</div>
            <div class="context-menu-item" onclick="window.open('${file.blobUrl}', '_blank'); closeContextMenu();"><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" style="vertical-align: -2px; margin-right: 4px;"><path d="M8 11l-4-4h2.5V2h3v5H12l-4 4z"/><path d="M13 13H3v1h10v-1z"/></svg> Download</div>
            <div class="context-menu-separator"></div>
            <div class="context-menu-item" onclick="editFile('${itemName}'); closeContextMenu();">‚úèÔ∏è Edit</div>
            <div class="context-menu-item" onclick="renameItem('${itemName}', false); closeContextMenu();">üìù Rename</div>
            <div class="context-menu-separator"></div>
            <div class="context-menu-item" onclick="deleteFile('${file.fullPath}'); closeContextMenu();">üóëÔ∏è Delete</div>
            <div class="context-menu-item" onclick="reindexFile('${file.fullPath}'); closeContextMenu();">üîÑ Reindex</div>
          `;
        }
        
        document.body.appendChild(menu);
        
        // Close menu when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closeContextMenu);
        }, 100);
      }
      
      function closeContextMenu() {
        const menu = document.querySelector('.context-menu');
        if (menu) menu.remove();
        document.removeEventListener('click', closeContextMenu);
      }
      
      // Open file handler
      async function openFile(fileName) {
        const currentFolder = getCurrentFolder();
        const file = currentFolder._files.find(f => f.name === fileName);
        
        if (!file) return;
        
        // Get file icon based on extension
        const ext = fileName.split('.').pop().toLowerCase();
        let fileIcon = getFileIcon(ext);
        
        // Format file information
        const fileSize = formatFileSize(file.size);
        const lastModified = file.lastModified ? new Date(file.lastModified).toLocaleString() : 'Unknown';
        
        // Show dialog for open options
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: white;
          padding: 0;
          border-radius: 10px;
          max-width: 600px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          position: relative;
        `;
        
        modalContent.innerHTML = `
          <!-- Header with file info and close button -->
          <div style="
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
          ">
            <!-- Close X button -->
            <button id="modalCloseBtn" style="
              position: absolute;
              top: 1rem;
              right: 1rem;
              background: transparent;
              border: none;
              font-size: 1.5rem;
              cursor: pointer;
              color: #666;
              width: 32px;
              height: 32px;
              display: flex;
              align-items: center;
              justify-content: center;
              border-radius: 4px;
              transition: all 0.2s;
            ">
              <span style="line-height: 1;">√ó</span>
            </button>
            
            <!-- File icon and name -->
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding-right: 3rem;">
              <div style="width: 32px; height: 32px; flex-shrink: 0;">
                ${fileIcon}
              </div>
              <h3 style="
                margin: 0;
                font-size: 1.1rem;
                word-break: break-word;
                line-height: 1.4;
                color: #333;
              ">${fileName}</h3>
            </div>
            
            <!-- File metadata -->
            <div style="
              display: flex;
              gap: 2rem;
              font-size: 0.85rem;
              color: #666;
              padding-left: 3rem;
            ">
              <div>
                <strong>Size:</strong> ${fileSize}
              </div>
              <div>
                <strong>Modified:</strong> ${lastModified}
              </div>
            </div>
          </div>
          
          <!-- Body with actions -->
          <div style="padding: 1.5rem 2rem;">
            <p style="margin-bottom: 1.5rem; color: #666;">Choose an action:</p>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              <!-- Download and Edit Option -->
              <div style="
                padding: 1rem;
                background: #f0f8ff;
                border: 1px solid #0078d4;
                border-radius: 8px;
              ">
                <h4 style="margin: 0 0 0.5rem 0; color: #0078d4;">‚úèÔ∏è Edit in Native Application</h4>
                <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #666;">
                  Download the file, edit it in Word/Excel/etc., then upload the updated version
                </p>
                <button id="downloadEditBtn" style="
                  padding: 0.75rem 1.5rem;
                  background: var(--blueprint-blue);
                  color: white;
                  border: none;
                  border-radius: 5px;
                  cursor: pointer;
                  width: 100%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 0.5rem;
                "><svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"><path d="M10 14l-5-5h3V3h4v6h3l-5 5z"/><path d="M16 16H4v2h12v-2z"/></svg> Download for Editing</button>
              </div>
              
              <!-- View Only Options -->
              <div style="
                padding: 1rem;
                background: #fffef5;
                border: 1px solid #ffc107;
                border-radius: 8px;
              ">
                <h4 style="margin: 0 0 0.5rem 0; color: #f57f17;">üëÅÔ∏è View Only</h4>
                <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #666;">
                  Open the file directly in your browser for viewing
                </p>
                <button id="viewBrowserBtn" style="
                  padding: 0.75rem 1rem;
                  background: white;
                  color: #333;
                  border: 1px solid #ccc;
                  border-radius: 5px;
                  cursor: pointer;
                  width: 100%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 0.5rem;
                ">üåê View in Browser</button>
              </div>
            </div>
            
            <button id="modalCancelBtn" style="
              margin-top: 1rem;
              padding: 0.75rem 1.5rem;
              background: #f0f0f0;
              color: #666;
              border: 1px solid #ccc;
              border-radius: 5px;
              cursor: pointer;
              width: 100%;
            ">Cancel</button>
          </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Add event listeners after the modal is in the DOM
        const closeModal = () => modal.remove();
        
        // Close button
        modalContent.querySelector('#modalCloseBtn').addEventListener('click', closeModal);
        
        // Cancel button
        modalContent.querySelector('#modalCancelBtn').addEventListener('click', closeModal);
        
        // Download for editing button
        modalContent.querySelector('#downloadEditBtn').addEventListener('click', () => {
          downloadAndTrackForEdit(file.blobUrl, fileName, file.fullPath);
          closeModal();
        });
        
        // View in browser button
        modalContent.querySelector('#viewBrowserBtn').addEventListener('click', () => {
          openInBrowser(file.blobUrl);
          closeModal();
        });
      }
      
      // Helper function to get file icon SVG
      function getFileIcon(ext) {
        // PDF files
        if (ext === 'pdf') {
          return `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <rect width="32" height="32" rx="2" fill="#DC372C"/>
            <path fill="white" d="M8.5 10.5h2.8c1.7 0 2.7 1 2.7 2.5s-1 2.5-2.7 2.5h-1.6v2.5H8.5v-7.5zm1.2 1v3h1.6c1 0 1.5-.6 1.5-1.5s-.5-1.5-1.5-1.5H9.7z"/>
            <path fill="white" d="M14.5 10.5h2.3c2.2 0 3.5 1.3 3.5 3.7s-1.3 3.8-3.5 3.8h-2.3v-7.5zm1.2 1v5.5h1.1c1.5 0 2.3-.9 2.3-2.8 0-1.8-.8-2.7-2.3-2.7h-1.1z"/>
            <path fill="white" d="M21 10.5h4.5v1H22.2v2.5h2.8v1h-2.8v3H21v-7.5z"/>
          </svg>`;
        }
        // Word documents
        else if (ext === 'docx' || ext === 'doc') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <path fill="#2B579A" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
            <path fill="#FFF" d="M9.5 11.5h1l.9 4.2h.05l1.05-4.2h1.5l1.05 4.2h.05l.9-4.2h1l-1.45 6h-1.55l-1-3.85h-.05l-1 3.85H10.95z"/>
          </svg>`;
        }
        // Excel spreadsheets
        else if (ext === 'xlsx' || ext === 'xls' || ext === 'csv') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <path fill="#107C41" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
            <path fill="#FFF" d="M8.5 11.5h1.5l1.5 3 1.5-3h1.5l-2.25 4.5 2.25 4.5h-1.5L12 17.5l-1.5 3H9l2.25-4.5z"/>
          </svg>`;
        }
        // PowerPoint
        else if (ext === 'pptx' || ext === 'ppt') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <path fill="#B7472A" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
            <path fill="#FFF" d="M9 11.5h3.5c1.93 0 3 1.07 3 2.75s-1.07 2.75-3 2.75H10.5v3.5H9v-9zm1.5 1.25v3h2c.83 0 1.5-.42 1.5-1.5s-.67-1.5-1.5-1.5h-2z"/>
          </svg>`;
        }
        // CAD/Drawing files
        else if (ext === 'dwg' || ext === 'dxf' || ext === 'rvt') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <rect fill="#E51937" width="24" height="24" rx="2"/>
            <text x="12" y="15" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="white" text-anchor="middle">DWG</text>
          </svg>`;
        }
        // Images
        else if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg', 'webp'].includes(ext)) {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <rect fill="#4285F4" width="24" height="24" rx="2"/>
            <circle cx="8" cy="8" r="2" fill="#FFF"/>
            <path fill="#FFF" d="M4 18h16l-5-6-4 4.5-2.5-3z"/>
          </svg>`;
        }
        // Default document icon
        else {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <path fill="#757575" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
            <path fill="#FFF" d="M7 11h10v1H7zm0 2h10v1H7zm0 2h7v1H7z"/>
          </svg>`;
        }
      }
      
      // Track file for editing and show upload prompt
      function downloadAndTrackForEdit(blobUrl, fileName, fullPath) {
        // Download the file
        window.open(blobUrl, '_blank');
        
        // Store the file info for tracking
        const editSession = {
          fileName: fileName,
          fullPath: fullPath,
          downloadTime: new Date().toISOString(),
          clientName: selectedClient
        };
        
        // Store in sessionStorage so it persists during the session
        sessionStorage.setItem('editingFile', JSON.stringify(editSession));
        
        // Show notification with upload instructions
        setTimeout(() => {
          showEditNotification(fileName, fullPath);
        }, 1000);
      }
      
      // Show notification for file being edited
      function showEditNotification(fileName, fullPath) {
        // Remove any existing edit notification
        const existingNotification = document.getElementById('editNotification');
        if (existingNotification) existingNotification.remove();
        
        const notification = document.createElement('div');
        notification.id = 'editNotification';
        notification.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: white;
          border: 2px solid var(--blueprint-blue);
          border-radius: 8px;
          padding: 1rem;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          max-width: 400px;
          animation: slideIn 0.3s ease-out;
        `;
        
        // Truncate long filenames for display
        const displayName = fileName.length > 40 ? fileName.substring(0, 37) + '...' : fileName;
        
        notification.innerHTML = `
          <div style="display: flex; align-items: start; gap: 1rem;">
            <div style="font-size: 2rem;">üìù</div>
            <div style="flex: 1;">
              <h4 style="margin: 0 0 0.5rem 0; color: var(--concrete-gray); word-break: break-word;" title="${fileName}">Editing: ${displayName}</h4>
              <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #666;">
                After editing in your application, click below to upload the updated version.
              </p>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button onclick="showUploadDialog('${fileName.replace(/'/g, "\\'").replace(/"/g, "&quot;")}', '${fullPath.replace(/'/g, "\\'").replace(/"/g, "&quot;")}')" style="
                  padding: 0.5rem 1rem;
                  background: var(--blueprint-blue);
                  color: white;
                  border: none;
                  border-radius: 5px;
                  cursor: pointer;
                  font-size: 0.9rem;
                  white-space: nowrap;
                ">üì§ Upload Updated</button>
                <button onclick="confirmDismissEdit()" style="
                  padding: 0.5rem 1rem;
                  background: #f0f0f0;
                  color: #666;
                  border: 1px solid #ccc;
                  border-radius: 5px;
                  cursor: pointer;
                  font-size: 0.9rem;
                ">Dismiss</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(notification);
      }
      
      // Helper function to show errors in modal
      function showModalError(modal, message) {
        // Remove any existing error message
        const existingError = modal.querySelector('.modal-error-message');
        if (existingError) {
          existingError.remove();
        }
        
        // Create error message element
        const errorDiv = document.createElement('div');
        errorDiv.className = 'modal-error-message';
        errorDiv.style.cssText = `
          background: #fee;
          border: 1px solid #fcc;
          border-radius: 5px;
          padding: 0.75rem;
          margin: 1rem 0;
          color: #c00;
          font-size: 0.9rem;
          display: flex;
          align-items: center;
          gap: 0.5rem;
        `;
        errorDiv.innerHTML = `
          <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
          <span>${message}</span>
        `;
        
        // Insert error after the title
        const modalContent = modal.querySelector('div[style*="background: white"]');
        if (modalContent) {
          const title = modalContent.querySelector('h3');
          if (title) {
            title.insertAdjacentElement('afterend', errorDiv);
          } else {
            modalContent.insertBefore(errorDiv, modalContent.firstChild);
          }
        }
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.remove();
          }
        }, 5000);
      }
      
      // Show upload dialog for edited file - make it global
      window.showUploadDialog = function(originalFileName, originalPath) {
        const modal = document.createElement('div');
        modal.id = 'uploadEditModal';
        
        // Truncate long filenames for display
        const displayName = originalFileName.length > 50 ? originalFileName.substring(0, 47) + '...' : originalFileName;
        
        modal.innerHTML = `
          <div style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            overflow-y: auto;
            padding: 1rem;
          ">
            <div style="
              background: white;
              padding: 2rem;
              border-radius: 10px;
              max-width: 500px;
              width: 100%;
              box-shadow: 0 10px 30px rgba(0,0,0,0.3);
              max-height: 90vh;
              overflow-y: auto;
              position: relative;
            ">
              <h3 style="margin-bottom: 1rem; color: var(--concrete-gray);">üì§ Upload Updated File</h3>
              <p style="margin-bottom: 1rem; color: #666; word-break: break-word;">
                Select the edited version of <strong title="${originalFileName}">${displayName}</strong> to replace the existing file.
              </p>
              
              <div style="
                border: 2px dashed var(--blueprint-blue);
                border-radius: 8px;
                padding: 2rem;
                text-align: center;
                background: #f8f9fa;
                margin-bottom: 1rem;
              ">
                <input type="file" id="editedFileInput" style="display: none;" accept=".pdf,.docx,.xlsx,.xls" />
                <div id="fileSelectionArea">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
                  <button onclick="document.getElementById('editedFileInput').click()" style="
                    padding: 0.75rem 1.5rem;
                    background: var(--blueprint-blue);
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                  ">Choose File</button>
                  <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">or drag and drop here</p>
                </div>
                <div id="selectedFileInfo" style="display: none;">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
                  <p style="color: var(--blueprint-blue); font-weight: 600; word-break: break-all; padding: 0 1rem;" id="selectedFileName"></p>
                  <p style="color: #666; font-size: 0.9rem;" id="selectedFileSize"></p>
                </div>
              </div>
              
              <div style="
                background: #fff3cd;
                border: 1px solid #ffc107;
                border-radius: 5px;
                padding: 0.75rem;
                margin-bottom: 1rem;
                display: flex;
                align-items: start;
                gap: 0.5rem;
              ">
                <span style="color: #f57f17;">‚ö†Ô∏è</span>
                <div style="font-size: 0.9rem; color: #856404;">
                  <strong>Note:</strong> The original file will be replaced. The indexer will automatically update to reflect your changes.
                </div>
              </div>
              
              <div style="display: flex; gap: 1rem;">
                <button id="uploadEditedFileBtn" onclick="uploadEditedFile('${originalPath}')" disabled style="
                  flex: 1;
                  padding: 0.75rem 1.5rem;
                  background: var(--safety-yellow);
                  color: var(--dark-gray);
                  border: none;
                  border-radius: 5px;
                  cursor: not-allowed;
                  font-weight: 600;
                  opacity: 0.5;
                ">Upload & Replace</button>
                <button onclick="confirmCancelUpload()" style="
                  padding: 0.75rem 1.5rem;
                  background: #f0f0f0;
                  color: #666;
                  border: 1px solid #ccc;
                  border-radius: 5px;
                  cursor: pointer;
                ">Cancel</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Set up file input handler
        const fileInput = document.getElementById('editedFileInput');
        const uploadBtn = document.getElementById('uploadEditedFileBtn');
        const fileSelectionArea = document.getElementById('fileSelectionArea');
        const selectedFileInfo = document.getElementById('selectedFileInfo');
        
        fileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            // Show selected file info
            fileSelectionArea.style.display = 'none';
            selectedFileInfo.style.display = 'block';
            
            // Truncate very long filenames for display but show full name on hover
            const fileName = file.name;
            const displayName = fileName.length > 60 ? fileName.substring(0, 30) + '...' + fileName.substring(fileName.length - 27) : fileName;
            const fileNameElement = document.getElementById('selectedFileName');
            fileNameElement.textContent = displayName;
            fileNameElement.title = fileName; // Show full name on hover
            
            document.getElementById('selectedFileSize').textContent = formatFileSize(file.size);
            
            // Enable upload button
            uploadBtn.disabled = false;
            uploadBtn.style.cursor = 'pointer';
            uploadBtn.style.opacity = '1';
            
            // Store the file for upload
            window.tempEditedFile = file;
          }
        });
        
        // Set up drag and drop
        const dropZone = fileInput.parentElement;
        
        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.style.background = '#e8f4fd';
        });
        
        dropZone.addEventListener('dragleave', (e) => {
          e.preventDefault();
          dropZone.style.background = '#f8f9fa';
        });
        
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.style.background = '#f8f9fa';
          
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            fileInput.files = files;
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
          }
        });
      }
      
      // Confirmation dialogs for dismissing edit notifications - make them global
      window.confirmDismissEdit = function() {
        if (confirm('Are you sure you want to dismiss? The AI model will not learn from any of your changes unless you upload the updated file.')) {
          const notification = document.getElementById('editNotification');
          if (notification) notification.remove();
          sessionStorage.removeItem('editingFile');
        }
      }
      
      window.confirmCancelUpload = function() {
        if (confirm('Are you sure you want to cancel? The AI model will not learn from any of your changes unless you upload the updated file.')) {
          const modal = document.getElementById('uploadEditModal');
          if (modal) modal.remove();
        }
      }
      
      // Upload the edited file to replace the original - make it global
      window.uploadEditedFile = async function(originalPath) {
        const file = window.tempEditedFile;
        if (!file) {
          // Show error in modal
          const modal = document.getElementById('uploadEditModal');
          if (modal) {
            showModalError(modal, 'No file selected. Please choose a file to upload.');
          }
          return;
        }
        
        const uploadBtn = document.getElementById('uploadEditedFileBtn');
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';
        
        try {
          // Parse the original path to properly handle encoding
          // The originalPath already contains the full path like "FCS-OriginalClients/clientname/category/filename"
          // We need to encode each segment properly while preserving the structure
          
          // First, normalize the path (remove any double slashes, trim)
          let normalizedPath = originalPath.replace(/\/+/g, '/').trim();
          
          // Encode each path segment separately
          const pathSegments = normalizedPath.split('/');
          const encodedSegments = pathSegments.map(segment => {
            // Skip empty segments
            if (!segment) return '';
            // Encode the segment, which will handle spaces and special characters
            return encodeURIComponent(segment);
          }).filter(s => s); // Remove empty segments
          
          const encodedPath = encodedSegments.join('/');
          
          // Construct the upload URL with the SAS token
          const uploadUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${encodedPath}${AZURE_STORAGE.sasToken}`;
          
          console.log('Original path:', originalPath);
          console.log('Encoded path:', encodedPath);
          console.log('Full upload URL:', uploadUrl); // Debug log
          
          const response = await fetch(uploadUrl, {
            method: 'PUT',
            headers: {
              'x-ms-blob-type': 'BlockBlob',
              'Content-Type': file.type || 'application/octet-stream',
              'x-ms-blob-content-disposition': `attachment; filename*=UTF-8''${encodeURIComponent(file.name)}`,
              'x-ms-blob-overwrite': 'true', // Explicitly overwrite the existing blob
              'x-ms-blob-cache-control': 'no-cache' // Prevent caching issues
            },
            body: file
          });
          
          if (response.ok || response.status === 201) {
            // Success! The file has been replaced in Azure Blob Storage
            const fileName = originalPath.split('/').pop();
            addSystemMessage(`‚úÖ File "${fileName}" has been successfully replaced with your updated version!`);
            
            // Clear the edit session
            sessionStorage.removeItem('editingFile');
            window.tempEditedFile = null;
            
            // Close the modal
            const modal = document.getElementById('uploadEditModal');
            if (modal) modal.remove();
            
            // Remove the edit notification if it exists
            const notification = document.getElementById('editNotification');
            if (notification) notification.remove();
            
            // Reload the file list to show the updated file
            await loadClientFiles(selectedClient);
            
            // Optionally trigger reindexing
            setTimeout(() => {
              if (confirm('Would you like to reindex this file to update the search index with your changes?')) {
                reindexFile(originalPath);
              }
            }, 500);
            
          } else {
            throw new Error(`Upload failed with status ${response.status}`);
          }
          
        } catch (error) {
          console.error('Error uploading edited file:', error);
          
          // Show error in modal instead of global error
          const modal = document.getElementById('uploadEditModal');
          if (modal) {
            const errorMsg = error.message.includes('Failed to fetch') ? 
              'Network error: Unable to connect to storage. Please check your internet connection and try again.' : 
              `Failed to upload edited file: ${error.message}`;
            showModalError(modal, errorMsg);
          }
          
          // Re-enable button
          uploadBtn.disabled = false;
          uploadBtn.textContent = 'Upload & Replace';
        }
      }
      
      function openInBrowser(url) {
        // For PDFs and other files that can be displayed in browser
        const win = window.open(url, '_blank');
        win.focus();
      }
      
      // Edit file - download, edit in native app, and re-upload
      function editFile(fileName) {
        const currentFolder = getCurrentFolder();
        const file = currentFolder._files.find(f => f.name === fileName);
        
        if (!file) return;
        
        // Use the same download and track function
        downloadAndTrackForEdit(file.blobUrl, fileName, file.fullPath);
      }
      
      // Rename item (placeholder - would need backend support)
      function renameItem(itemName, isFolder) {
        const newName = prompt(`Enter new name for ${isFolder ? 'folder' : 'file'}:`, itemName);
        if (newName && newName !== itemName) {
          addSystemMessage(`üìù Rename feature coming soon. Azure Blob Storage rename operations require server-side implementation.`);
        }
      }
      
      // Delete file
      async function deleteFile(filePath) {
        const fileName = filePath.split('/').pop();
        if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
          return;
        }
        
        try {
          const deleteUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${filePath}${AZURE_STORAGE.sasToken}`;
          
          const response = await fetch(deleteUrl, {
            method: 'DELETE',
            headers: {
              'x-ms-delete-snapshots': 'include'
            }
          });
          
          if (response.ok || response.status === 202) {
            addSystemMessage(`‚úÖ File "${fileName}" deleted successfully!`);
            // Reload the file list
            await loadClientFiles(selectedClient);
          } else {
            throw new Error(`Delete failed with status ${response.status}`);
          }
        } catch (error) {
          console.error('Error deleting file:', error);
          showError(`Failed to delete file: ${error.message}`);
        }
      }
      
      // Delete folder (would need to delete all contents)
      async function deleteFolder(folderName) {
        if (!confirm(`Are you sure you want to delete the folder "${folderName}" and all its contents?`)) {
          return;
        }
        addSystemMessage(`üìÅ Folder deletion requires deleting all files within it. This feature requires server-side implementation for batch operations.`);
      }
      
      // Reindex file
      async function reindexFile(filePath) {
        const fileName = filePath.split('/').pop();
        addSystemMessage(`üîÑ Reindexing "${fileName}"... Processing document for search index update.`);
        
        // Parse the file path to get client and category info
        const pathParts = filePath.split('/');
        const clientName = pathParts[1]; // After FCS-OriginalClients/
        
        // Determine category from path or filename
        let category = 'documents';
        const lowerPath = filePath.toLowerCase();
        
        if (lowerPath.includes('/drawings/') || lowerPath.includes('drawing') || lowerPath.includes('plan')) {
          category = 'drawings';
        } else if (lowerPath.includes('/estimates/') || lowerPath.includes('estimate')) {
          category = 'estimates';
        } else if (lowerPath.includes('/proposals/') || lowerPath.includes('proposal')) {
          category = 'proposals';
        } else if (lowerPath.includes('/specs/') || lowerPath.includes('spec')) {
          category = 'specs';
        } else if (lowerPath.includes('/contracts/') || lowerPath.includes('contract')) {
          category = 'signed-contracts';
        }
        
        try {
          // First, download the file content from Azure
          const blobUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${filePath}${AZURE_STORAGE.sasToken}`;
          
          const response = await fetch(blobUrl);
          if (!response.ok) {
            throw new Error(`Failed to fetch file: ${response.status}`);
          }
          
          const blob = await response.blob();
          const file = new File([blob], fileName, { type: blob.type });
          
          // Create form data for the processing webhook
          const formData = new FormData();
          formData.append('file', file);
          formData.append('category', category);
          formData.append('client', clientName);  // Keep original capitalization
          formData.append('action', 'reindex'); // Flag this as a reindex operation
          
          // Call the processing webhook
          const processResponse = await fetch(API_CONFIG.uploadWebhookUrl, {
            method: 'POST',
            body: formData
          });
          
          if (!processResponse.ok) {
            const errorText = await processResponse.text();
            throw new Error(`HTTP ${processResponse.status}: ${errorText}`);
          }
          
          const result = await processResponse.json();
          addSystemMessage(`‚úÖ File "${fileName}" has been successfully reindexed!`);
          
        } catch (error) {
          console.error('Error reindexing file:', error);
          addSystemMessage(`‚ö†Ô∏è Failed to reindex "${fileName}": ${error.message}`);
        }
      }
      
      // Render the file browser view
      function renderFileBrowser() {
        const fileList = document.getElementById('fileList');
        if (!fileList) return;
        
        fileList.innerHTML = '';
        
        // Add navigation bar
        const navBar = document.createElement('div');
        navBar.className = 'file-browser-navigation';
        
        const backButton = document.createElement('button');
        backButton.className = 'nav-button';
        backButton.innerHTML = '‚¨ÖÔ∏è';
        backButton.disabled = currentPath.length === 0;
        backButton.onclick = navigateBack;
        
        const upButton = document.createElement('button');
        upButton.className = 'nav-button';
        upButton.innerHTML = '‚¨ÜÔ∏è';
        upButton.disabled = currentPath.length === 0;
        upButton.onclick = navigateBack;
        
        const breadcrumb = document.createElement('div');
        breadcrumb.className = 'breadcrumb';
        
        // Root
        const rootItem = document.createElement('span');
        rootItem.className = 'breadcrumb-item';
        rootItem.textContent = 'üìÅ ' + (clientSelect.options[clientSelect.selectedIndex]?.text || 'Root');
        rootItem.onclick = () => navigateToPath(0);
        breadcrumb.appendChild(rootItem);
        
        // Path items
        currentPath.forEach((folder, index) => {
          const separator = document.createElement('span');
          separator.className = 'breadcrumb-separator';
          separator.textContent = '>';
          breadcrumb.appendChild(separator);
          
          const pathItem = document.createElement('span');
          pathItem.className = 'breadcrumb-item';
          pathItem.textContent = folder;
          pathItem.onclick = () => navigateToPath(index + 1);
          breadcrumb.appendChild(pathItem);
        });
        
        navBar.appendChild(backButton);
        navBar.appendChild(upButton);
        navBar.appendChild(breadcrumb);
        fileList.appendChild(navBar);
        
        // Get current folder content
        const currentFolder = getCurrentFolder();
        
        // Create items container
        const itemsContainer = document.createElement('div');
        itemsContainer.style.padding = '0.5rem';
        
        // Display folders first
        const folders = Object.keys(currentFolder).filter(key => key !== '_files').sort();
        
        folders.forEach(folderName => {
          const folderItem = document.createElement('div');
          folderItem.className = 'folder-item';
          if (selectedFiles.has(folderName)) {
            folderItem.classList.add('selected');
          }
          
          folderItem.onclick = (e) => handleItemClick(e, folderName, true);
          folderItem.oncontextmenu = (e) => showContextMenu(e, folderName, true);
          
          // Count items in folder
          const folderContent = currentFolder[folderName];
          let itemCount = 0;
          if (folderContent._files) itemCount += folderContent._files.length;
          itemCount += Object.keys(folderContent).filter(k => k !== '_files').length;
          
          folderItem.innerHTML = `
            <div class="existing-file-info">
              <div class="file-icon">üìÅ</div>
              <div class="existing-file-name">${folderName}</div>
              <div class="existing-file-meta">
                <span class="file-meta-item">${itemCount} items</span>
              </div>
            </div>
          `;
          
          itemsContainer.appendChild(folderItem);
        });
        
        // Display files
        const files = currentFolder._files || [];
        files.sort((a, b) => a.name.localeCompare(b.name));
        
        files.forEach(file => {
          const fileItem = document.createElement('div');
          fileItem.className = 'existing-file-item';
          if (selectedFiles.has(file.name)) {
            fileItem.classList.add('selected');
          }
          
          fileItem.onclick = (e) => handleItemClick(e, file.name, false);
          fileItem.oncontextmenu = (e) => showContextMenu(e, file.name, false);
          
          // Get file icon based on extension - using actual logos
          const ext = file.name.split('.').pop().toLowerCase();
          let icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path fill="#BDBDBD" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
          </svg>`; // Default generic document
          
          // PDF files - Adobe PDF logo (classic style)
          if (ext === 'pdf') {
            icon = `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect width="32" height="32" rx="2" fill="#DC372C"/>
              <path fill="white" d="M8.5 10.5h2.8c1.7 0 2.7 1 2.7 2.5s-1 2.5-2.7 2.5h-1.6v2.5H8.5v-7.5zm1.2 1v3h1.6c1 0 1.5-.6 1.5-1.5s-.5-1.5-1.5-1.5H9.7z"/>
              <path fill="white" d="M14.5 10.5h2.3c2.2 0 3.5 1.3 3.5 3.7s-1.3 3.8-3.5 3.8h-2.3v-7.5zm1.2 1v5.5h1.1c1.5 0 2.3-.9 2.3-2.8 0-1.8-.8-2.7-2.3-2.7h-1.1z"/>
              <path fill="white" d="M21 10.5h4.5v1H22.2v2.5h2.8v1h-2.8v3H21v-7.5z"/>
            </svg>`;
          }
          // Word documents - Microsoft Word logo
          else if (ext === 'docx' || ext === 'doc' || ext === 'docm' || ext === 'dotx' || ext === 'dot') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#2B579A" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M9.5 11.5h1l.9 4.2h.05l1.05-4.2h1.5l1.05 4.2h.05l.9-4.2h1l-1.45 6h-1.55l-1-3.85h-.05l-1 3.85H10.95z"/>
            </svg>`;
          }
          // Excel spreadsheets - Microsoft Excel logo
          else if (ext === 'xlsx' || ext === 'xls' || ext === 'xlsm' || ext === 'xlsb' || ext === 'xltx' || ext === 'xlt' || ext === 'csv') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#107C41" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M8.5 11.5h1.5l1.5 3 1.5-3h1.5l-2.25 4.5 2.25 4.5h-1.5L12 17.5l-1.5 3H9l2.25-4.5z"/>
            </svg>`;
          }
          // PowerPoint presentations - Microsoft PowerPoint logo
          else if (ext === 'pptx' || ext === 'ppt' || ext === 'pptm' || ext === 'potx' || ext === 'pot' || ext === 'ppsx' || ext === 'pps') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#B7472A" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M9 11.5h3.5c1.93 0 3 1.07 3 2.75s-1.07 2.75-3 2.75H10.5v3.5H9v-9zm1.5 1.25v3h2c.83 0 1.5-.42 1.5-1.5s-.67-1.5-1.5-1.5h-2z"/>
            </svg>`;
          }
          // Image files
          else if (ext === 'png' || ext === 'jpg' || ext === 'jpeg' || ext === 'gif' || ext === 'bmp' || ext === 'svg' || ext === 'webp' || ext === 'ico' || ext === 'tiff' || ext === 'tif') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect fill="#4285F4" width="24" height="24" rx="2"/>
              <circle cx="8" cy="8" r="2" fill="#FFF"/>
              <path fill="#FFF" d="M4 18h16l-5-6-4 4.5-2.5-3z"/>
            </svg>`;
          }
          // CAD/Drawing files - AutoCAD style
          else if (ext === 'dwg' || ext === 'dxf' || ext === 'dwf' || ext === 'dgn' || ext === 'rvt' || ext === 'ifc' || ext === 'skp') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect fill="#E51937" width="24" height="24" rx="2"/>
              <text x="12" y="15" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="white" text-anchor="middle">DWG</text>
            </svg>`;
          }
          // Archive files
          else if (ext === 'zip' || ext === 'rar' || ext === '7z' || ext === 'tar' || ext === 'gz' || ext === 'bz2') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#F4B400" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <rect x="10" y="4" width="2" height="2" fill="#FFF" opacity=".7"/>
              <rect x="10" y="6" width="2" height="2" fill="#FFF" opacity=".6"/>
              <rect x="10" y="8" width="2" height="2" fill="#FFF" opacity=".5"/>
              <rect x="10" y="10" width="2" height="2" fill="#FFF" opacity=".4"/>
              <path fill="#FFF" d="M9 13h6v5H9z"/>
            </svg>`;
          }
          // Text files
          else if (ext === 'txt' || ext === 'log' || ext === 'md' || ext === 'rtf') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#757575" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M7 11h10v1H7zm0 2h10v1H7zm0 2h7v1H7z"/>
            </svg>`;
          }
          // Email files - Outlook style
          else if (ext === 'msg' || ext === 'eml' || ext === 'oft') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#0078D4" d="M21 4H3a2 2 0 00-2 2v12a2 2 0 002 2h18a2 2 0 002-2V6a2 2 0 00-2-2z"/>
              <path fill="#FFF" d="M21 7l-9 6-9-6V6l9 6 9-6z"/>
            </svg>`;
          }
          // Video files
          else if (ext === 'mp4' || ext === 'avi' || ext === 'mov' || ext === 'wmv' || ext === 'flv' || ext === 'mkv' || ext === 'webm') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect fill="#FF5722" width="24" height="24" rx="2"/>
              <path fill="#FFF" d="M8 6h8a1 1 0 011 1v10a1 1 0 01-1 1H8a1 1 0 01-1-1V7a1 1 0 011-1zm9 5.5L19 10v4l-2-1.5z"/>
            </svg>`;
          }
          // Audio files
          else if (ext === 'mp3' || ext === 'wav' || ext === 'flac' || ext === 'aac' || ext === 'ogg' || ext === 'wma' || ext === 'm4a') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect fill="#673AB7" width="24" height="24" rx="2"/>
              <path fill="#FFF" d="M12 3v10.55A4 4 0 1014 17V7h4V3h-6z"/>
            </svg>`;
          }
          // Code/Script files
          else if (ext === 'js' || ext === 'ts' || ext === 'py' || ext === 'java' || ext === 'c' || ext === 'cpp' || ext === 'cs' || ext === 'php' || ext === 'rb' || ext === 'go' || ext === 'swift' || ext === 'kt' || ext === 'rs' || ext === 'html' || ext === 'css' || ext === 'scss' || ext === 'sass' || ext === 'json' || ext === 'xml' || ext === 'yaml' || ext === 'yml' || ext === 'sql') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect fill="#1F1F1F" width="24" height="24" rx="2"/>
              <path fill="#4EC9B0" d="M8 16l-4-4 4-4 1.5 1.5L7 12l2.5 2.5z"/>
              <path fill="#CE9178" d="M16 16l4-4-4-4-1.5 1.5L17 12l-2.5 2.5z"/>
            </svg>`;
          }
          // OneNote files - Microsoft OneNote logo
          else if (ext === 'one' || ext === 'onetoc2' || ext === 'onepkg') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#7719AA" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M8 11h1.5l2.5 5.5V11h1.5v8H12l-2.5-5.5V19H8z"/>
            </svg>`;
          }
          // Visio files - Microsoft Visio logo
          else if (ext === 'vsdx' || ext === 'vsd' || ext === 'vss' || ext === 'vst' || ext === 'vssx' || ext === 'vstx') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#3955A3" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <text x="12" y="16" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="white" text-anchor="middle">V</text>
            </svg>`;
          }
          // Project files - Microsoft Project logo
          else if (ext === 'mpp' || ext === 'mpt') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#31752F" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M8 11h3.5c1.93 0 3 1.07 3 2.75s-1.07 2.75-3 2.75H9.5V19H8v-8zm1.5 1.25v3h2c.83 0 1.5-.42 1.5-1.5s-.67-1.5-1.5-1.5h-2z"/>
            </svg>`;
          }
          
          const formattedDate = file.lastModified ? new Date(file.lastModified).toLocaleDateString() : '';
          
          fileItem.innerHTML = `
            <div class="existing-file-info">
              <div class="file-icon">${icon}</div>
              <div class="existing-file-name" title="${file.name}">${file.name}</div>
            </div>
            <div class="file-details-row">
              <div class="existing-file-meta">
                <span class="file-meta-item">${formatFileSize(file.size)}</span>
                <span class="file-meta-item file-meta-date">${formattedDate}</span>
              </div>
              <div class="existing-file-actions">
                <button class="file-action-btn" onclick="downloadAndTrackForEdit('${file.blobUrl}', '${file.name.replace(/'/g, "\\'").replace(/"/g, "&quot;")}', '${file.fullPath.replace(/'/g, "\\'").replace(/"/g, "&quot;")}'); event.stopPropagation();"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"><path d="M12 15l-5-5h3V4h4v6h3l-5 5z"/><path d="M19 18H5v2h14v-2z"/></svg></button>
                <button class="file-action-btn" onclick="deleteFile('${file.fullPath}'); event.stopPropagation();">üóëÔ∏è</button>
              </div>
            </div>
          `;
          
          itemsContainer.appendChild(fileItem);
        });
        
        // Show empty message if no items
        if (folders.length === 0 && files.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'no-files-message';
          emptyMsg.innerHTML = 'üìÇ This folder is empty';
          itemsContainer.appendChild(emptyMsg);
        }
        
        fileList.appendChild(itemsContainer);
      }
      
      // Load existing files for a specific client from Azure Blob Storage
      async function loadClientFiles(clientName) {
        const fileList = document.getElementById("fileList");
        if (!fileList) return;
        
        // Reset navigation
        currentPath = [];
        selectedFiles.clear();
        
        // Show loading indicator
        fileList.innerHTML = '';
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading-indicator active';
        loadingDiv.textContent = 'Loading files...';
        fileList.appendChild(loadingDiv);
        
        try {
          // Construct the Azure Blob Storage URL to list files for this client
          const actualClientName = clientSelect.options[clientSelect.selectedIndex].text.split(' - ')[0];
          const prefix = `FCS-OriginalClients/${actualClientName}/`;
          const listUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=${encodeURIComponent(prefix)}`;
          
          const response = await fetch(listUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/xml'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const xmlText = await response.text();
          console.log(`Files for client ${actualClientName}:`, xmlText);
          
          // Parse the XML response
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, "text/xml");
          
          // Get all blobs (files)
          const blobs = xmlDoc.getElementsByTagName("Blob");
          const files = [];
          
          for (let i = 0; i < blobs.length; i++) {
            const nameElement = blobs[i].getElementsByTagName("Name")[0];
            const propertiesElement = blobs[i].getElementsByTagName("Properties")[0];
            
            if (nameElement) {
              const fullPath = nameElement.textContent;
              const pathParts = fullPath.split('/');
              const fileName = pathParts[pathParts.length - 1];
              
              // Skip if it's not a real file (empty name)
              if (fileName && fileName.length > 0) {
                let fileSize = 0;
                let lastModified = '';
                let contentType = '';
                
                // Extract file properties if available
                if (propertiesElement) {
                  const sizeElement = propertiesElement.getElementsByTagName("Content-Length")[0];
                  const modifiedElement = propertiesElement.getElementsByTagName("Last-Modified")[0];
                  const typeElement = propertiesElement.getElementsByTagName("Content-Type")[0];
                  
                  if (sizeElement) fileSize = parseInt(sizeElement.textContent) || 0;
                  if (modifiedElement) lastModified = modifiedElement.textContent;
                  if (typeElement) contentType = typeElement.textContent;
                }
                
                files.push({
                  name: fileName,
                  fullPath: fullPath,
                  size: fileSize,
                  lastModified: lastModified,
                  contentType: contentType,
                  blobUrl: `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${fullPath}${AZURE_STORAGE.sasToken}`
                });
              }
            }
          }
          
          // Build hierarchical structure
          fileStructure = buildFileStructure(files);
          
          // Render the file browser
          renderFileBrowser();
          
          console.log(`Loaded ${files.length} files for client ${actualClientName}`);
          
        } catch (error) {
          console.error('Error loading client files:', error);
          fileList.innerHTML = '';
          const errorDiv = document.createElement('div');
          errorDiv.className = 'no-files-message';
          errorDiv.innerHTML = `‚ö†Ô∏è Error loading files: ${error.message}`;
          fileList.appendChild(errorDiv);
        }
      }
      
      // Delete a file from Azure Blob Storage
      async function deleteClientFile(filePath, clientName) {
        if (!confirm(`Are you sure you want to delete ${filePath.split('/').pop()}?`)) {
          return;
        }
        
        try {
          const deleteUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${filePath}${AZURE_STORAGE.sasToken}`;
          
          const response = await fetch(deleteUrl, {
            method: 'DELETE',
            headers: {
              'x-ms-delete-snapshots': 'include'
            }
          });
          
          if (response.ok || response.status === 202) {
            addSystemMessage(`‚úÖ File deleted successfully!`);
            // Reload the file list
            await loadClientFiles(clientName);
          } else {
            throw new Error(`Delete failed with status ${response.status}`);
          }
        } catch (error) {
          console.error('Error deleting file:', error);
          showError(`Failed to delete file: ${error.message}`);
        }
      }
      
      // Make loadClientFiles available globally for the refresh button
      window.loadClientFiles = loadClientFiles;
      window.deleteClientFile = deleteClientFile;
    </script>
  </body>
</html>
        